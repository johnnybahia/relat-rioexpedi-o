<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relat√≥rio de Pedidos (v20.0 COMPAT√çVEL - Backend v15.5)</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 10px; }
    #loader { display: flex; flex-direction: column; align-items: center; justify-content: center; position: fixed; inset: 0; background-color: rgba(255,255,255,0.9); z-index: 1000; }
    #loader.hidden { display: none; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loading-text { margin-top: 1rem; font-size: 1rem; color: #374151; }
    .container { max-width: 1280px; margin-left: auto; margin-right: auto; background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); padding: 1.5rem; }
    .header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; gap: 0.5rem;}
    .header h1 { font-size: 1.5rem; font-weight: bold; color: #1f2937; margin: 0; }
    .header-meta { font-size: 0.875rem; color: #6b7280; text-align: right; }
    #refreshButton { padding: 0.5rem; border-radius: 9999px; transition: background-color 0.2s; background: none; border: none; cursor: pointer;}
    #refreshButton:hover { background-color: #f3f4f6; }
    #refreshButton svg { height: 1.25rem; width: 1.25rem; color: #3b82f6; display: block;}
    
    /* √Årea de controles em uma linha */
    .controls-wrapper { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding: 0.75rem; background-color: #f9fafb; border-radius: 0.5rem; border: 1px solid #e5e7eb; flex-wrap: wrap; }
    
    .global-actions { display: flex; gap: 0.5rem; align-items: center; }
    .btn-global-action { padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); white-space: nowrap; }
    .btn-global-action:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-faturar-global { background-color: #22c55e; color: white; }
    .btn-faturar-global:hover:not(:disabled) { background-color: #16a34a; box-shadow: 0 2px 4px 0 rgba(0,0,0,0.1); }
    .btn-excluir-global { background-color: #ef4444; color: white; }
    .btn-excluir-global:hover:not(:disabled) { background-color: #dc2626; box-shadow: 0 2px 4px 0 rgba(0,0,0,0.1); }
    .selected-count { font-size: 0.75rem; color: #6b7280; font-weight: 500; white-space: nowrap; }
    
    .filters { display: flex; gap: 0.5rem; align-items: center; flex: 1; }
    .filter-input { width: 200px; border-radius: 0.5rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; font-size: 0.875rem; background-color: #fff; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
    .filter-select { border-radius: 0.5rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; font-size: 0.875rem; background-color: #fff; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); cursor: pointer; }
    
    /* Autocomplete */
    .filter-wrapper { position: relative; }
    .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-radius: 0.5rem; margin-top: 0.25rem; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; display: none; }
    .autocomplete-list.visible { display: block; }
    .autocomplete-item { padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.75rem; border-bottom: 1px solid #f3f4f6; }
    .autocomplete-item:hover, .autocomplete-item.selected { background-color: #eff6ff; }
    .autocomplete-item:last-child { border-bottom: none; }
    
    /* NOVO: Totalizadores gerais */
    .totals-wrapper { display: flex; gap: 1rem; align-items: center; padding: 0.5rem 0.75rem; background-color: #eff6ff; border-radius: 0.5rem; border: 1px solid #3b82f6; }
    .total-item { display: flex; flex-direction: column; align-items: center; }
    .total-label { font-size: 0.625rem; color: #6b7280; font-weight: 600; text-transform: uppercase; }
    .total-value { font-size: 1rem; color: #1f2937; font-weight: 700; }
    
    #stats { font-size: 0.625rem; color: #9ca3af; padding: 0; white-space: nowrap; }
    
    #cards-container { display: flex; flex-direction: column; gap: 1.5rem; }
    
    .card { background-color: #ffffff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); overflow: hidden; }
    .card.has-pending-faturados { border: 3px solid #ef4444; background-color: #fef2f2; }
    
    /* Linha selecionada por teclado */
    tr.keyboard-selected { outline: 3px solid #3b82f6; outline-offset: -3px; background-color: #eff6ff !important; }
    
    .card-header { padding: 0.75rem 1rem; background-color: #f9fafb; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
    .card-header h3 { margin: 0; color: #1f2937; font-size: 1em; font-weight: 600; flex: 1; }
    .card.has-pending-faturados .card-header { background-color: #fee2e2; border-bottom: 2px solid #ef4444; }
    .card.has-pending-faturados .card-header h3 { color: #991b1b; }
    
    /* NOVO: Totalizador do card */
    .card-totals { display: flex; gap: 0.75rem; align-items: center; font-size: 0.75rem; padding: 0.25rem 0.5rem; background-color: #f0fdf4; border-radius: 0.375rem; border: 1px solid #22c55e; }
    .card-total-item { display: flex; align-items: center; gap: 0.25rem; }
    .card-total-label { color: #166534; font-weight: 600; }
    .card-total-value { color: #14532d; font-weight: 700; }
    
    /* Card message */
    .card-message { padding: 0.5rem 1rem; background-color: #fef3c7; color: #92400e; text-align: center; font-weight: 600; font-size: 0.75rem; border-bottom: 1px solid #f59e0b; }
    
    /* Badge de status de prazo */
    .prazo-badge { font-size: 0.75rem; font-weight: 700; padding: 0.25rem 0.5rem; border-radius: 0.25rem; white-space: nowrap; text-transform: uppercase; }
    .prazo-badge.atrasado { background-color: #fecaca; color: #991b1b; }
    .prazo-badge.no-prazo-limite { background-color: #fef3c7; color: #92400e; }
    .prazo-badge.em-prazo { background-color: #bbf7d0; color: #14532d; }
    
    .card-body { padding: 0; overflow-x: auto; }
    .card-body.loading { padding: 15px; text-align: center; color: #888; }
    .card-body.error { padding: 15px; text-align: center; color: red; }
    
    .item-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .item-table th, .item-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
    .item-table th { background-color: #f9fafb; font-weight: 600; color: #374151; border-bottom-width: 2px; border-color: #e5e7eb; white-space: nowrap; }
    .item-table tr:last-child td { border-bottom: none; }
    
    .item-table td.status-prazo { font-weight: 600; text-align: center; }
    .item-table tr.item-inativo { background-color: #f3f4f6; opacity: 0.85; }
    .item-table tr.item-faturado { background-color: #dcfce7; font-weight: 500; }
    
    .item-table tr.keyboard-focus { outline: 3px solid #3b82f6; outline-offset: -3px; }
    
    .item-checkbox { width: 18px; height: 18px; cursor: pointer; margin: 0; }
    .checkbox-cell { width: 40px; text-align: center; }
    .btn-finalizar { padding: 4px 10px; background-color: #3b82f6; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.75rem; font-weight: 500; transition: background-color 0.2s; }
    .btn-finalizar:hover { background-color: #2563eb; }
    .btn-finalizar:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.6; }
    .btn-finalizar:disabled:hover { background-color: #9ca3af; }
    
    .nowrap { white-space: nowrap; }
    .description-col { min-width: 200px; }
    
    #controls { text-align: center; margin-top: 1.25rem; }
    #btnMore { display: inline-flex; align-items: center; gap: 0.5rem; border-radius: 0.5rem; border: 1px solid #d1d5db; padding: 0.75rem 1.5rem; font-size: 0.9rem; font-weight: 500; cursor: pointer; background: white; }
    #btnMore:hover { background-color: #f9fafb; }
    #btnMore:disabled { opacity: 0.5; cursor: not-allowed; }
    #btnMore.hidden { display: none; }
    
    #noResults { display: none; color: #6b7280; padding: 2rem 0; text-align: center; }
    #noResults.visible { display: block; }
    
    /* Modais */
    .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000; }
    .modal-overlay.hidden { display: none; }
    .modal-content { background: white; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-width: 600px; width: 90%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { padding: 1.25rem; border-bottom: 1px solid #e5e7eb; background-color: #f9fafb; }
    .modal-header h2 { margin: 0; font-size: 1.25rem; font-weight: 700; color: #1f2937; }
    .modal-header.warning { background-color: #fef3c7; border-bottom-color: #f59e0b; }
    .modal-header.warning h2 { color: #92400e; }
    .modal-body { padding: 1.25rem; overflow-y: auto; flex: 1; }
    .modal-section { margin-bottom: 1.5rem; }
    .modal-section h3 { font-size: 1rem; font-weight: 600; margin: 0 0 0.75rem 0; color: #374151; }
    .modal-section.faturar h3 { color: #16a34a; }
    .modal-section.excluir h3 { color: #dc2626; }
    .modal-item-list { list-style: none; padding: 0; margin: 0; }
    .modal-item-list li { padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; background-color: #f9fafb; border-radius: 0.375rem; border-left: 3px solid #d1d5db; font-size: 0.875rem; }
    .modal-section.faturar .modal-item-list li { border-left-color: #22c55e; background-color: #f0fdf4; }
    .modal-section.excluir .modal-item-list li { border-left-color: #ef4444; background-color: #fef2f2; }
    .modal-footer { padding: 1rem 1.25rem; border-top: 1px solid #e5e7eb; display: flex; gap: 0.75rem; justify-content: flex-end; background-color: #f9fafb; }
    .modal-btn { padding: 0.6rem 1.5rem; border: none; border-radius: 0.5rem; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .modal-btn-confirm { background-color: #22c55e; color: white; }
    .modal-btn-confirm:hover { background-color: #16a34a; }
    .modal-btn-danger { background-color: #ef4444; color: white; }
    .modal-btn-danger:hover { background-color: #dc2626; }
    .modal-btn-cancel { background-color: #e5e7eb; color: #374151; }
    .modal-btn-cancel:hover { background-color: #d1d5db; }
    
    .modal-message { font-size: 1rem; line-height: 1.6; color: #374151; text-align: center; font-weight: 500; padding: 1rem; }
    .modal-message.warning { color: #92400e; background-color: #fef3c7; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; }
    
    /* Bot√µes de ler lista e listas colaps√°veis */
    .toggle-list-btn { background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; margin: 0.75rem 0; font-size: 0.875rem; font-weight: 600; transition: background 0.2s; }
    .toggle-list-btn:hover { background: #2563eb; }
    .collapsible-section { margin: 1rem 0; }
    .collapsible-list { display: none; margin-top: 1rem; }
    .collapsible-list.visible { display: block; }
    
    .keyboard-hint { position: fixed; bottom: 1rem; right: 1rem; background: #1f2937; color: white; padding: 0.75rem 1rem; border-radius: 0.5rem; font-size: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); z-index: 1500; opacity: 0.9; }
    .keyboard-hint.hidden { display: none; }
    .keyboard-hint kbd { background: #374151; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-family: monospace; margin: 0 0.25rem; }

    /* Barra de Progresso */
    .progress-bar-container { width: 120px; height: 20px; background-color: #e5e7eb; border-radius: 10px; overflow: hidden; position: relative; border: 1px solid #d1d5db; }
    .progress-bar-fill { height: 100%; transition: width 0.3s ease, background-color 0.3s ease; border-radius: 10px 0 0 10px; }
    .progress-bar-fill.full { border-radius: 10px; }
    .progress-bar-fill.verde { background: linear-gradient(90deg, #22c55e, #16a34a); }
    .progress-bar-fill.amarelo { background: linear-gradient(90deg, #eab308, #ca8a04); }
    .progress-bar-fill.laranja { background: linear-gradient(90deg, #f97316, #ea580c); }
    .progress-bar-fill.vermelho { background: linear-gradient(90deg, #ef4444, #dc2626); }
    .progress-text { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 0.625rem; font-weight: 700; color: #1f2937; z-index: 1; text-shadow: 0 0 3px rgba(255,255,255,0.8); }

    /* Bot√£o de baixa parcial */
    .btn-baixa { padding: 4px 10px; background-color: #3b82f6; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.7rem; font-weight: 500; transition: background-color 0.2s; margin-right: 4px; }
    .btn-baixa:hover { background-color: #2563eb; }
    .btn-baixa:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.6; }

    /* Modal de Baixa Parcial */
    .modal-baixa-info { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: #f9fafb; border-radius: 0.5rem; margin-bottom: 1rem; }
    .modal-baixa-qtds { display: flex; gap: 1.5rem; align-items: center; font-size: 0.875rem; }
    .modal-baixa-qtd-item { display: flex; flex-direction: column; }
    .modal-baixa-qtd-label { color: #6b7280; font-size: 0.75rem; font-weight: 600; }
    .modal-baixa-qtd-value { color: #1f2937; font-size: 1.25rem; font-weight: 700; }
    .modal-baixa-progress { flex: 1; max-width: 300px; }

    .historico-section { margin-top: 1.5rem; }
    .historico-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
    .historico-header h3 { margin: 0; font-size: 0.875rem; font-weight: 600; color: #374151; }
    .historico-count { font-size: 0.75rem; color: #6b7280; background-color: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }

    .historico-list { max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; background-color: #fff; }
    .historico-item { padding: 0.75rem 1rem; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; }
    .historico-item:last-child { border-bottom: none; }
    .historico-item.ultima { background-color: #eff6ff; border-left: 3px solid #3b82f6; }
    .historico-item-info { display: flex; gap: 1rem; align-items: center; }
    .historico-item-qtd { font-weight: 700; color: #ef4444; font-size: 0.9rem; }
    .historico-item-data { color: #6b7280; font-size: 0.7rem; }
    .historico-item-actions { display: flex; gap: 0.5rem; }
    .btn-editar-baixa { padding: 0.25rem 0.5rem; background-color: #f59e0b; color: white; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 0.7rem; font-weight: 500; transition: background-color 0.2s; }
    .btn-editar-baixa:hover { background-color: #d97706; }

    .nova-baixa-section { margin-top: 1.5rem; padding: 1rem; background-color: #f0fdf4; border: 2px dashed #22c55e; border-radius: 0.5rem; }
    .nova-baixa-section h3 { margin: 0 0 0.75rem 0; font-size: 0.875rem; font-weight: 600; color: #166534; }
    .nova-baixa-input-group { display: flex; gap: 0.75rem; align-items: flex-end; }
    .nova-baixa-input-wrapper { flex: 1; }
    .nova-baixa-input-wrapper label { display: block; font-size: 0.75rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem; }
    .nova-baixa-input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
    .nova-baixa-hint { margin-top: 0.5rem; font-size: 0.7rem; color: #6b7280; text-align: center; }
    .nova-baixa-hint strong { color: #374151; }

    .editar-baixa-form { padding: 1rem; background-color: #fef3c7; border: 2px solid #f59e0b; border-radius: 0.5rem; margin-top: 1rem; }
    .editar-baixa-form h4 { margin: 0 0 0.75rem 0; font-size: 0.875rem; font-weight: 600; color: #92400e; }
    .editar-baixa-info { font-size: 0.75rem; color: #78350f; margin-bottom: 0.75rem; }
    .editar-baixa-exemplos { font-size: 0.7rem; color: #6b7280; margin-top: 0.5rem; padding: 0.5rem; background-color: #fffbeb; border-radius: 0.25rem; }
    .editar-baixa-exemplos ul { margin: 0.25rem 0; padding-left: 1.5rem; }
    .editar-baixa-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }

    /* Bot√£o de Relat√≥rio de Produ√ß√£o */
    #btn-relatorio-producao:hover { background: #047857; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.15); }
    #btn-relatorio-producao:active { transform: translateY(0); }
  </style>
</head>
<body>

  <!-- Loader -->
  <div id="loader" class="hidden">
    <div class="spinner"></div>
    <div id="loading-text">Carregando...</div>
  </div>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>Relat√≥rio de Pedidos</h1>
      <div class="header-meta">
        <div id="updated-at">Carregando...</div>
        <div id="stats"></div>
      </div>
      <button id="refreshButton" title="Atualizar dados">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
      </button>
    </div>

    <!-- Controles -->
    <div class="controls-wrapper">
      <!-- A√ß√µes Globais -->
      <div class="global-actions">
        <button id="btn-faturar-global" class="btn-global-action btn-faturar-global" disabled>Faturado sem finalizar</button>
        <button id="btn-excluir-global" class="btn-global-action btn-excluir-global" disabled>Excluir</button>
        <span id="selected-count" class="selected-count">0 itens selecionados</span>
      </div>

      <!-- Filtros -->
      <div class="filters">
        <div class="filter-wrapper">
          <input type="text" id="search-oc" class="filter-input" placeholder="Buscar OC ou Cliente..." autocomplete="off">
          <div id="autocomplete-list" class="autocomplete-list"></div>
        </div>
        <select id="filter-status" class="filter-select">
          <option value="all">Todos os Status</option>
          <option value="with-checkboxes">Pendentes de confirma√ß√£o de faturamento</option>
          <option value="pending-faturados">Com Itens Faturados</option>
        </select>
        <select id="filter-prazo" class="filter-select">
          <option value="tudo">Todos os Prazos</option>
          <option value="atrasados">Atrasados</option>
          <option value="em-prazo">No Prazo Limite</option>
          <option value="a-vencer">A Vencer</option>
          <option value="atrasados-em-prazo">Atrasados + No Prazo Limite</option>
        </select>
      </div>

      <!-- Bot√£o Relat√≥rio de Produ√ß√£o -->
      <div style="margin: 1rem 0; text-align: center;">
        <button id="btn-relatorio-producao" class="btn-primary" style="padding: 0.75rem 2rem; font-size: 1rem; background: #059669; border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;">
          üìÑ Imprimir Relat√≥rio de Produ√ß√£o
        </button>
      </div>

      <!-- NOVO: Totalizadores Gerais -->
      <div class="totals-wrapper">
        <div class="total-item">
          <span class="total-label">Metros</span>
          <span id="total-metros" class="total-value">0</span>
        </div>
        <div class="total-item">
          <span class="total-label">Pares</span>
          <span id="total-pares" class="total-value">0</span>
        </div>
      </div>
    </div>

    <!-- Cards Container -->
    <div id="cards-container"></div>

    <!-- No Results -->
    <div id="noResults">Nenhuma OC encontrada com os filtros aplicados.</div>

    <!-- Controls -->
    <div id="controls">
      <button id="btnMore" class="hidden">Carregar mais</button>
    </div>
  </div>

  <!-- Modal de Aviso -->
  <div id="warningModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header warning">
        <h2>‚ö†Ô∏è Aten√ß√£o: Existem Itens j√° faturados abaixo!</h2>
      </div>
      <div class="modal-body">
        <p class="modal-message warning">
          Existem <strong><span id="warning-inactive-count">0</span></strong> Itens Faturados que precisam ser marcados como faturado sem finalizar ou exclu√≠dos.
        </p>
        <p style="text-align: center; color: #6b7280; font-size: 0.875rem;">
  Selecione os itens usando as caixas de sele√ß√£o e use os bot√µes "Faturado sem finalizar" ou "Excluir" no topo da p√°gina.
</p>
        <div class="collapsible-section">
          <button class="toggle-list-btn" onclick="toggleInactiveList()">Ver Lista de Itens Faturados</button>
          <ul id="warning-item-list" class="modal-item-list collapsible-list"></ul>
        </div>
      </div>
      <div class="modal-footer">
        <button id="warning-ok-btn" class="modal-btn modal-btn-cancel">Entendi</button>
        <button id="warning-delete-btn" class="modal-btn modal-btn-danger">Excluir Todos</button>
      </div>
    </div>
  </div>

  <!-- Modal de Confirma√ß√£o de Faturamento -->
  <div id="confirmModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Confirmar A√ß√£o</h2>
      </div>
      <div class="modal-body">
        <div class="modal-section faturar">
          <h3>‚úì Itens a Faturar (<span id="faturar-count">0</span>)</h3>
          <ul id="modal-faturar-list" class="modal-item-list"></ul>
        </div>
        <div class="modal-section excluir">
          <h3>‚úó Itens a Excluir (<span id="excluir-count">0</span>)</h3>
          <ul id="modal-excluir-list" class="modal-item-list"></ul>
        </div>
      </div>
      <div class="modal-footer">
        <button id="modal-cancel-btn" class="modal-btn modal-btn-cancel">Cancelar</button>
        <button id="modal-confirm-btn" class="modal-btn modal-btn-confirm">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Exclus√£o em Massa -->
  <div id="deleteAllModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header warning">
        <h2>‚ö†Ô∏è Confirmar Exclus√£o</h2>
      </div>
      <div class="modal-body">
        <p class="modal-message warning">
          Voc√™ est√° prestes a excluir os seguintes itens:
        </p>
        <ul id="delete-all-list" class="modal-item-list"></ul>
      </div>
      <div class="modal-footer">
        <button id="delete-all-cancel-btn" class="modal-btn modal-btn-cancel">Cancelar</button>
        <button id="delete-all-confirm-btn" class="modal-btn modal-btn-danger">Confirmar Exclus√£o</button>
      </div>
    </div>
  </div>

  <!-- Modal de Sucesso -->
  <div id="successModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚úÖ Sucesso</h2>
      </div>
      <div class="modal-body">
        <p id="success-message" class="modal-message"></p>
      </div>
      <div class="modal-footer">
  <p class="modal-message" style="font-weight:700; text-align:center;">
    Por favor, clicar em <strong>F5</strong>.
  </p>
</div>    
</div>
  </div>

  <!-- Modal de Baixa Parcial -->
  <div id="baixaModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üì¶ Baixa Parcial</h2>
      </div>
      <div class="modal-body">
        <!-- Info do item -->
        <div class="modal-baixa-info">
          <div class="modal-baixa-qtds">
            <div class="modal-baixa-qtd-item">
              <span class="modal-baixa-qtd-label">QTD. ORIGINAL</span>
              <span id="baixa-qtd-original" class="modal-baixa-qtd-value">200</span>
            </div>
            <div style="font-size: 1.5rem; color: #d1d5db;">‚Üí</div>
            <div class="modal-baixa-qtd-item">
              <span class="modal-baixa-qtd-label">QTD. ABERTA</span>
              <span id="baixa-qtd-aberta" class="modal-baixa-qtd-value">85</span>
            </div>
          </div>
          <div class="modal-baixa-progress">
            <div class="progress-bar-container">
              <div id="baixa-progress-bar" class="progress-bar-fill verde" style="width: 75%"></div>
              <div id="baixa-progress-text" class="progress-text">75%</div>
            </div>
          </div>
        </div>

        <!-- Descri√ß√£o do item -->
        <p id="baixa-item-desc" style="font-size: 0.875rem; color: #6b7280; text-align: center; margin-bottom: 1.5rem;"></p>

        <!-- Hist√≥rico -->
        <div id="historico-section" class="historico-section" style="display: none;">
          <div class="historico-header">
            <h3>üìã Hist√≥rico de Baixas</h3>
            <span id="historico-count" class="historico-count">0 registros</span>
          </div>
          <div id="historico-list" class="historico-list"></div>
        </div>

        <!-- Formul√°rio de edi√ß√£o (oculto inicialmente) -->
        <div id="editar-baixa-form" class="editar-baixa-form" style="display: none;">
          <h4>‚úèÔ∏è Editar √öltima Baixa</h4>
          <div class="editar-baixa-info">
            Baixa atual: <strong id="editar-baixa-atual">-20</strong>
          </div>
          <div class="nova-baixa-input-wrapper">
            <label>Nova quantidade:</label>
            <input type="text" id="editar-baixa-input" class="nova-baixa-input" placeholder="Ex: 30 ou +10">
          </div>
          <div class="editar-baixa-exemplos">
            <strong>Exemplos:</strong>
            <ul>
              <li><code>30</code> ‚Üí altera para baixa de 30</li>
              <li><code>+10</code> ‚Üí reverte 10 unidades (ficar√° -10)</li>
              <li><code>5</code> ‚Üí altera para baixa de 5</li>
            </ul>
          </div>
          <div class="editar-baixa-actions">
            <button id="salvar-edicao-btn" class="modal-btn modal-btn-confirm">Salvar</button>
            <button id="cancelar-edicao-btn" class="modal-btn modal-btn-cancel">Cancelar</button>
          </div>
        </div>

        <!-- Nova baixa -->
        <div id="nova-baixa-section" class="nova-baixa-section">
          <h3>‚ûï Nova Baixa</h3>
          <div class="nova-baixa-input-group">
            <div class="nova-baixa-input-wrapper">
              <label>Quantidade (m√°x: <span id="baixa-max-qtd">85</span>):</label>
              <input type="text" id="nova-baixa-input" class="nova-baixa-input" placeholder="Digite a quantidade">
            </div>
          </div>
          <div class="nova-baixa-hint">
            üí° Digite apenas o n√∫mero para dar baixa<br>
            Use <strong>+10</strong> para aumentar (reverter)
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="baixa-cancel-btn" class="modal-btn modal-btn-cancel">Fechar</button>
        <button id="baixa-confirm-btn" class="modal-btn modal-btn-confirm">Adicionar Baixa</button>
      </div>
    </div>
  </div>

  <!-- Modal de Relat√≥rio de Produ√ß√£o -->
  <div id="relatorioModal" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2>üìÑ Relat√≥rio de Produ√ß√£o</h2>
      </div>
      <div class="modal-body">
        <!-- Filtro de Marfim -->
        <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f3f4f6; border-radius: 8px;">
          <h3 style="margin: 0 0 0.75rem 0; font-size: 1rem; color: #374151;">Filtrar por Marfim:</h3>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="radio" name="marfim-filter" value="all" checked>
              <span>Todos (CM + MM)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="radio" name="marfim-filter" value="cm">
              <span>Apenas CM</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="radio" name="marfim-filter" value="mm">
              <span>Apenas MM</span>
            </label>
          </div>
        </div>

        <!-- Campo de busca -->
        <div style="margin-bottom: 1rem;">
          <input
            type="text"
            id="busca-ocs-relatorio"
            placeholder="üîç Buscar OC ou Cliente..."
            style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; transition: border-color 0.2s;"
            autocomplete="off"
          >
        </div>

        <!-- A√ß√µes de sele√ß√£o -->
        <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem; justify-content: space-between; align-items: center;">
          <div style="display: flex; gap: 0.75rem;">
            <button id="selecionar-todas-ocs" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
              ‚úì Selecionar Todas
            </button>
            <button id="limpar-selecao-ocs" style="padding: 0.5rem 1rem; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
              ‚úó Limpar Sele√ß√£o
            </button>
          </div>
          <span id="contador-ocs-selecionadas" style="font-weight: 600; color: #059669;">0 OCs selecionadas</span>
        </div>

        <!-- Lista de OCs -->
        <div id="lista-ocs-relatorio" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 0.5rem;">
          <!-- Ser√° preenchido dinamicamente -->
        </div>
      </div>
      <div class="modal-footer">
        <button id="relatorio-cancel-btn" class="modal-btn modal-btn-cancel">Cancelar</button>
        <button id="relatorio-gerar-btn" class="modal-btn modal-btn-confirm">Gerar Relat√≥rio</button>
      </div>
    </div>
  </div>

  <!-- Keyboard Hint -->
  <div id="keyboard-hint" class="keyboard-hint hidden">
    Use <kbd>‚Üë</kbd> <kbd>‚Üì</kbd> para navegar e <kbd>Espa√ßo</kbd> para selecionar
  </div>

  <script>
    // ==== VARI√ÅVEIS GLOBAIS ====
    let ALL_OCS_INFO = [];
    let FILTERED_OCS_INFO = [];
    let ALL_OCS_ITEMS = {};
    let appMeta = {};
    let totalInactiveItems = 0;
    let warningModalShown = false; // Flag para controlar exibi√ß√£o do modal de aviso

    // Navega√ß√£o por teclado
    let allInactiveRows = [];
    let currentKeyboardIndex = -1;
    let allVisibleRows = [];
    let currentRowIndex = -1;
    
    // Autocomplete
    let autocompleteData = [];
    let autocompleteIndex = -1;
    
    // ==== ELEMENTOS DO DOM ====
    const $loader = document.getElementById('loader');
    const $loadingText = document.getElementById('loading-text');
    const $updatedAt = document.getElementById('updated-at');
    const $stats = document.getElementById('stats');
    const $cardsContainer = document.getElementById('cards-container');
    const $btnMore = document.getElementById('btnMore');
    const $noResults = document.getElementById('noResults');
    const $refreshButton = document.getElementById('refreshButton');
    
    // Filtros
    const $searchOC = document.getElementById('search-oc');
    const $filterStatus = document.getElementById('filter-status');
    const $filterPrazo = document.getElementById('filter-prazo');
    const $autocompleteList = document.getElementById('autocomplete-list');
    
    // A√ß√µes Globais
    const $btnFaturarGlobal = document.getElementById('btn-faturar-global');
    const $btnExcluirGlobal = document.getElementById('btn-excluir-global');
    const $selectedCount = document.getElementById('selected-count');
    
    // NOVO: Totalizadores
    const $totalMetros = document.getElementById('total-metros');
    const $totalPares = document.getElementById('total-pares');
    
    // Modais
    const $warningModal = document.getElementById('warningModal');
    const $warningInactiveCount = document.getElementById('warning-inactive-count');
    const $warningItemList = document.getElementById('warning-item-list');
    const $warningOkBtn = document.getElementById('warning-ok-btn');
    const $warningDeleteBtn = document.getElementById('warning-delete-btn');
    
    const $confirmModal = document.getElementById('confirmModal');
    const $modalFaturarList = document.getElementById('modal-faturar-list');
    const $modalExcluirList = document.getElementById('modal-excluir-list');
    const $modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const $modalCancelBtn = document.getElementById('modal-cancel-btn');
    
    const $deleteAllModal = document.getElementById('deleteAllModal');
    const $deleteAllList = document.getElementById('delete-all-list');
    const $deleteAllConfirmBtn = document.getElementById('delete-all-confirm-btn');
    const $deleteAllCancelBtn = document.getElementById('delete-all-cancel-btn');
    
    const $successModal = document.getElementById('successModal');
    const $successMessage = document.getElementById('success-message');

    const $keyboardHint = document.getElementById('keyboard-hint');

    // Modal de Baixa Parcial
    const $baixaModal = document.getElementById('baixaModal');
    const $baixaQtdOriginal = document.getElementById('baixa-qtd-original');
    const $baixaQtdAberta = document.getElementById('baixa-qtd-aberta');
    const $baixaProgressBar = document.getElementById('baixa-progress-bar');
    const $baixaProgressText = document.getElementById('baixa-progress-text');
    const $baixaItemDesc = document.getElementById('baixa-item-desc');
    const $historicoSection = document.getElementById('historico-section');
    const $historicoCount = document.getElementById('historico-count');
    const $historicoList = document.getElementById('historico-list');
    const $editarBaixaForm = document.getElementById('editar-baixa-form');
    const $editarBaixaAtual = document.getElementById('editar-baixa-atual');
    const $editarBaixaInput = document.getElementById('editar-baixa-input');
    const $salvarEdicaoBtn = document.getElementById('salvar-edicao-btn');
    const $cancelarEdicaoBtn = document.getElementById('cancelar-edicao-btn');
    const $novaBaixaSection = document.getElementById('nova-baixa-section');
    const $novaBaixaInput = document.getElementById('nova-baixa-input');
    const $baixaMaxQtd = document.getElementById('baixa-max-qtd');
    const $baixaConfirmBtn = document.getElementById('baixa-confirm-btn');
    const $baixaCancelBtn = document.getElementById('baixa-cancel-btn');

    // Dados do item atual no modal de baixa
    let currentBaixaItem = null;
    
    // ==== FUN√á√ïES AUXILIARES ====

    function show(el, visible) {
        if (!el) return;
        if (visible) {
            el.classList.remove('hidden');
        } else {
            el.classList.add('hidden');
        }
    }
    
    function fmtInt(val) {
        const num = Number(val);
        if (isNaN(num)) return '0';
        return num.toLocaleString('pt-BR', { maximumFractionDigits: 0 });
    }
    
    function _normSearch_(str) {
        if (!str) return '';
        return String(str).trim().toUpperCase();
    }
    
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // ===== COMPATIBILIZA√á√ÉO v15.5 (normaliza√ß√£o de chaves sem mudar funcionalidades) =====
    function normalizeItemKeys(i) {
      return {
        'CARTELA': i.cartela ?? 'N/A',
        'C√ìD. CLIENTE': i.codCliente ?? 'N/A',
        'DESCRI√á√ÉO': i.descricao ?? 'N/A',
        'TAMANHO': i.tamanho ?? 'N/A',
        'QTD. ABERTA': i.qtdAberta ?? 0,
        'PRAZO': i.prazo ?? null,
        'DT. ENTREGA': i.dtEntrega ?? null,
        'Status': i.status ?? 'Desconhecido',
        uniqueId: i.uniqueId,
        planilhaLinha: i.planilhaLinha
      };
    }
    
    // ==== AUTOCOMPLETE ====
    
    function buildAutocompleteData() {
        autocompleteData = ALL_OCS_INFO.map(oc => ({
            label: `${oc.ordCompra} - ${oc.cliente}`,
            value: oc.ordCompra
        }));
        console.log(`üîç Dados de autocomplete constru√≠dos: ${autocompleteData.length} itens`);
    }
    
    $searchOC.addEventListener('input', (e) => {
        const term = _normSearch_(e.target.value);
        
        if (term.length < 1) {
            hideAutocomplete();
            aplicarFiltros();
            return;
        }
        
        const matches = autocompleteData.filter(item => 
            _normSearch_(item.label).includes(term)
        ).slice(0, 10);
        
        if (matches.length > 0) {
            showAutocomplete(matches);
        } else {
            hideAutocomplete();
        }
        
        aplicarFiltros();
    });
    
    $searchOC.addEventListener('keydown', (e) => {
        const items = $autocompleteList.querySelectorAll('.autocomplete-item');
        if (items.length === 0) return;
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            autocompleteIndex = Math.min(autocompleteIndex + 1, items.length - 1);
            updateAutocompleteSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            autocompleteIndex = Math.max(autocompleteIndex - 1, -1);
            updateAutocompleteSelection(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (autocompleteIndex >= 0 && autocompleteIndex < items.length) {
                items[autocompleteIndex].click();
            }
        } else if (e.key === 'Escape') {
            hideAutocomplete();
        }
    });
    
    $searchOC.addEventListener('blur', () => {
        setTimeout(() => hideAutocomplete(), 200);
    });
    
    function updateAutocompleteSelection(items) {
        items.forEach((item, idx) => {
            if (idx === autocompleteIndex) {
                item.classList.add('selected');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('selected');
            }
        });
    }
    
    function showAutocomplete(matches) {
        $autocompleteList.innerHTML = '';
        autocompleteIndex = -1;
        
        matches.forEach((match, idx) => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.textContent = match.label;
            item.dataset.value = match.value;
            $autocompleteList.appendChild(item);
        });
        
        $autocompleteList.classList.add('visible');
        
        // Adicionar event listeners
        $autocompleteList.querySelectorAll('.autocomplete-item').forEach((item, idx) => {
            item.addEventListener('click', () => {
                $searchOC.value = item.dataset.value;
                hideAutocomplete();
                aplicarFiltros();
            });
        });
    }
    
    function hideAutocomplete() {
        $autocompleteList.classList.remove('visible');
        $autocompleteList.innerHTML = '';
        autocompleteIndex = -1;
    }
    
    // ==== FUN√á√ïES DE C√ÅLCULO ====
    
    // Determina unidade baseada no tamanho
    function getUnidade(tamanho) {
        const tamanhoUpper = String(tamanho || '').toUpperCase();
        if (tamanhoUpper.includes('MM')) {
            return 'metros';
        } else if (tamanhoUpper.includes('CM')) {
            return 'Pares';
        } else {
            return 'unidades';
        }
    }
    
    // Formata descri√ß√£o completa do item para listas
    function formatItemInfo(desc, tamanho, qtd) {
        const unidade = getUnidade(tamanho);
        const tamanhoStr = tamanho && tamanho !== 'N/A' ? ` - ${tamanho}` : '';
        return `${desc}${tamanhoStr} - ${fmtInt(qtd)} ${unidade}`;
    }
    
    // NOVO: Calcula totais de metros e pares de um conjunto de itens
    function calcularTotais(items) {
        let totalMetros = 0;
        let totalPares = 0;
        
        items.forEach(item => {
            const qtd = Number(item['QTD. ABERTA']) || 0;
            const unidade = getUnidade(item.TAMANHO);
            
            if (unidade === 'metros') {
                totalMetros += qtd;
            } else if (unidade === 'Pares') {
                totalPares += qtd;
            }
        });
        
        return { metros: totalMetros, pares: totalPares };
    }
    
    // Calcula o prazo m√≠nimo do card (menor prazo entre todos os itens)
    function calcularPrazoMinimo(items) {
        if (!items || items.length === 0) return null;
        const prazos = items.map(item => {
            const prazo = item.PRAZO;
            if (prazo === null || prazo === undefined || prazo === 'N/A') return Infinity;
            return Number(prazo);
        }).filter(p => !isNaN(p));
        
        if (prazos.length === 0) return null;
        return Math.min(...prazos);
    }
    
    // Determina o status do prazo
    function getStatusPrazo(prazo) {
        if (prazo === null || prazo === undefined) return null;
        if (prazo < 0) return 'atrasado';
        if (prazo === 0) return 'no-prazo-limite';
        return 'em-prazo';
    }
    
    // Obt√©m o texto do badge de prazo
    function getTextoPrazo(status) {
        if (status === 'atrasado') return 'ATRASADO';
        if (status === 'no-prazo-limite') return 'NO PRAZO LIMITE';
        if (status === 'em-prazo') return 'EM PRAZO';
        return '';
    }
    
    function formatarData(dataInput) {
      if (!dataInput) return 'N/A';
      try {
        let data;
        if (typeof dataInput === 'number') {
          const excelEpoch = new Date(1899, 11, 30);
          data = new Date(excelEpoch.getTime() + (dataInput * 86400000));
        } else if (dataInput instanceof Date) {
          data = dataInput;
        } else if (typeof dataInput === 'string') {
          const s = dataInput.trim();
          // SE j√° vier do backend como dd/MM/yyyy, n√£o reparse
          if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) return s;
          data = new Date(s);
        } else {
          return 'N/A';
        }
        if (isNaN(data.getTime())) return 'Data Inv√°lida';
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const ano = data.getFullYear();
        if (!dia || dia === 'NaN') return 'N/A';
        return `${dia}/${mes}/${ano}`;
      } catch (e) {
        console.error('Erro ao formatar data:', e, 'Input:', dataInput);
        return 'Erro Data';
      }
    }

    // ==== CARREGAMENTO DE DADOS ====

    function carregarListaOcs(isRefresh = false) {
        console.log("üöÄ SISTEMA UNIFICADO v19.0 - Carregando TUDO em 1 chamada...");
        $loader.classList.remove('hidden');
        $loadingText.textContent = isRefresh ? 'Atualizando...' : 'Carregando dados...';

        // Reset da flag de modal de aviso em refresh/carregamento completo
        warningModalShown = false;

        const cacheBuster = Date.now(); // Cache buster
        
        google.script.run
            .withSuccessHandler(response => {
                console.log("‚úÖ Resposta recebida:", response);
                
                if (response && response.success) {
                    // Backend v15.5 retorna: { success, ordCompras, allItems, stats, meta }
                    console.log("üîç DEBUG - Resposta completa:", response);

                    // =======================
                    // COMPAT v15.5 (normaliza sem mudar o restante do front)
                    // =======================
                    ALL_OCS_INFO = (response.ordCompras || []).map(oc => ({
                      ordCompra: oc.ordCompraId,     // front usa "ordCompra"
                      cliente: oc.cliente
                    }));

                   // Converter array ordCompras para objeto indexado (sempre { ok, items })
const itemsObj = {};
if (response.ordCompras) {
  response.ordCompras.forEach(oc => {
    const key = oc.ordCompra || oc.ordCompraId;
    itemsObj[key] = { ok: true, items: oc.items || [] };

    // Debug: Mostrar campos dispon√≠veis no primeiro item da primeira OC
    if (oc.items && oc.items.length > 0 && Object.keys(itemsObj).length === 1) {
      console.log('üìã Campos dispon√≠veis nos itens:', Object.keys(oc.items[0]));
      console.log('üìã Primeiro item completo:', oc.items[0]);
    }
  });
}
ALL_OCS_ITEMS = itemsObj;
 // =======================

                    appMeta = response.meta || {};
                    
                    console.log(`‚úÖ ${ALL_OCS_INFO.length} OCs carregadas`);
                    console.log(`‚úÖ ${Object.keys(ALL_OCS_ITEMS).length} OCs com itens`);
                    console.log(`‚úÖ Total de itens: ${response.stats ? response.stats.totalItems : 0}`);
                    console.log(`‚è±Ô∏è Tempo: ${appMeta.executionTime || 0}ms`);
                    if (appMeta.fromCache) {
                        console.log(`üì¶ Dados do cache`);
                    }
                    
                    // Atualizar metadados
                    if (appMeta.displayTime) {
                        $updatedAt.textContent = 'Atualizado: ' + appMeta.displayTime;
                    } else if (appMeta.timestamp) {
                        $updatedAt.textContent = 'Atualizado: ' + new Date(appMeta.timestamp).toLocaleString('pt-BR');
                    }
                    
                    // Construir autocomplete
                    buildAutocompleteData();
                    
                    // Limpar container se for refresh
                    if (isRefresh) {
                        $cardsContainer.innerHTML = '';
                    }
                    
                    // Aplicar filtros e renderizar
                    aplicarFiltros();
                    
                } else {
                    console.error("‚ùå Resposta inv√°lida:", response);
                    alert("Erro ao carregar dados: " + (response && response.error ? response.error : "Resposta inv√°lida"));
                }
                
                $loader.classList.add('hidden');
            })
             .withFailureHandler(error => {
  console.error('‚ùå Erro ao faturar:', error);
  alert('Falha ao faturar itens: ' + error.message);
  $btnFaturarGlobal.disabled = false;
  $btnFaturarGlobal.textContent = 'Faturado sem finalizar'; // ‚Üê aqui
})
           
.fetchAllDataUnified(cacheBuster);
    }

    function aplicarFiltros() {
        const searchTerm = _normSearch_($searchOC.value);
        const statusFilter = $filterStatus.value;
        const prazoFilter = $filterPrazo.value;
        
        let filtered = [...ALL_OCS_INFO];
        
        if (searchTerm) {
            filtered = filtered.filter(oc => {
                const ocNorm = _normSearch_(oc.ordCompra);
                const clienteNorm = _normSearch_(oc.cliente);
                return ocNorm.includes(searchTerm) || clienteNorm.includes(searchTerm);
            });
        }
        
        if (statusFilter === 'with-checkboxes') {
            filtered = filtered.filter(oc => {
                const ocData = ALL_OCS_ITEMS[oc.ordCompra];
                if (!ocData || !ocData.items) return false;
                return ocData.items.some(item => item.Status === 'Inativo');
            });
        } else if (statusFilter === 'pending-faturados') {
            filtered = filtered.filter(oc => {
                const ocData = ALL_OCS_ITEMS[oc.ordCompra];
                if (!ocData || !ocData.items) return false;
                return ocData.items.some(item => item.Status === 'Faturado');
            });
        }
        
        // Filtro de prazo
        if (prazoFilter !== 'tudo') {
            filtered = filtered.filter(oc => {
                const ocData = ALL_OCS_ITEMS[oc.ordCompra];
                if (!ocData || !ocData.items) return false;
                const prazoMin = calcularPrazoMinimo(ocData.items);
                if (prazoMin === null) return false;
                
                switch(prazoFilter) {
                    case 'atrasados':
                        return prazoMin < 0;
                    case 'em-prazo':
                        return prazoMin === 0;
                    case 'a-vencer':
                        return prazoMin > 0;
                    case 'atrasados-em-prazo':
                        return prazoMin <= 0;
                    default:
                        return true;
                }
            });
        }
        
        FILTERED_OCS_INFO = filtered;
        $cardsContainer.innerHTML = '';
        console.log(`üîç Filtros aplicados. OCs filtradas: ${FILTERED_OCS_INFO.length}`);
        
        if (FILTERED_OCS_INFO.length === 0) {
            $noResults.classList.add('visible');
            updateStats();
            updateTotaisGerais();
        } else {
            $noResults.classList.remove('visible');
            
            // RENDERIZAR CARDS DIRETAMENTE (dados j√° est√£o carregados!)
            renderizarTodosOsCards();
        }
    }
    
    function renderizarTodosOsCards() {
  console.log(`üì¶ Renderizando ${FILTERED_OCS_INFO.length} cards...`);

  const cards = [];
  totalInactiveItems = 0;

  FILTERED_OCS_INFO.forEach(ocInfo => {
    const ocData = ALL_OCS_ITEMS[ocInfo.ordCompra];
    if (!ocData || !ocData.items || ocData.items.length === 0) return;

    const items = ocData.items.filter(i => i.Status !== 'Excluido');
    if (items.length === 0) return;

    const hasInativos   = items.some(i => i.Status === 'Inativo');
    const hasFaturados  = items.some(i => i.Status === 'Faturado');
    const prazoMin      = calcularPrazoMinimo(items);
    const prazoKey      = (prazoMin === null || isNaN(prazoMin)) ? Infinity : prazoMin;
    const groupRank     = hasInativos ? 0 : (hasFaturados ? 1 : 2);

    if (hasInativos) {
      totalInactiveItems += items.filter(i => i.Status === 'Inativo').length;
    }

    cards.push({
      ocInfo,
      items,
      hasInativos,
      hasFaturados,
      prazoKey,
      groupRank,
      ocKey: String(ocInfo.ordCompra || '')
    });
  });

  console.log(
    `üìä grupos => inativos:${cards.filter(c=>c.groupRank===0).length} `
    + `faturados:${cards.filter(c=>c.groupRank===1).length} `
    + `normais:${cards.filter(c=>c.groupRank===2).length}`
  );
  console.log(`üîµ Total inativos: ${totalInactiveItems}`);

  // ORDENAR: grupo (0,1,2) depois prazo ascendente
  cards.sort((a, b) => {
    if (a.groupRank !== b.groupRank) return a.groupRank - b.groupRank;
    if (a.prazoKey !== b.prazoKey)   return a.prazoKey - b.prazoKey;
    // desempate est√°vel
    return a.ocKey.localeCompare(b.ocKey, 'pt-BR', { numeric: true, sensitivity: 'base' });
  });

  // Limpar e renderizar na ordem
  $cardsContainer.innerHTML = '';
  cards.forEach(c => {
    renderOcCard(c.ocInfo, { ok: true, items: c.items });
  });

  updateStats();
  updateInactiveRowsList();
  updateVisibleRows();
  updateTotaisGerais();

  // S√≥ mostra modal de aviso se ainda n√£o foi mostrado nesta sess√£o
  if (totalInactiveItems > 0 && !warningModalShown) {
    console.log(`‚ö†Ô∏è ${totalInactiveItems} itens inativos - mostrando modal`);
    showWarningModal();
    warningModalShown = true; // Marca como mostrado
  }
}



    function renderOcCard(ocInfo, itemResponse) {
        if (!ocInfo || !ocInfo.ordCompra) { 
            console.error("‚ùå renderOcCard chamado com ocInfo inv√°lido:", ocInfo); 
            return; 
        }

        let card = document.createElement("div");
        card.className = "card";
        const ocIdLimpo = String(ocInfo.ordCompra).replace(/[^a-zA-Z0-9-]/g, '');
        const cardId = "card-" + ocIdLimpo;
        
        let existingCard = document.getElementById(cardId);
        if (existingCard) { 
            existingCard.innerHTML = ''; 
            card = existingCard; 
        } else { 
            card.id = cardId; 
        }

        let items = [];
        let hasInactiveItems = false;
        let hasFaturadosItems = false;
        
        if (itemResponse && itemResponse.ok === true && itemResponse.items && itemResponse.items.length > 0) {
            items = itemResponse.items.filter(item => item.Status !== 'Excluido');
            hasInactiveItems = items.some(item => item.Status === 'Inativo');
            hasFaturadosItems = items.some(item => item.Status === 'Faturado');
            
            console.log(`üîß Renderizando OC ${ocInfo.ordCompra}: ${items.length} itens vis√≠veis (${items.filter(i => i.Status === 'Inativo').length} inativos)`);
        }

        // DEBUG: Mostra warning se n√£o tiver itens mas deveria ter
        if (items.length === 0 && itemResponse.ok === true) {
            console.warn(`‚ö†Ô∏è OC ${ocInfo.ordCompra}: Card seria removido (0 itens vis√≠veis). Response:`, itemResponse);
            if (existingCard) {
                existingCard.remove();
            }
            return;
        }

        if (hasFaturadosItems) {
            card.classList.add('has-pending-faturados');
        } else {
            card.classList.remove('has-pending-faturados');
        }

        // Calcula prazo e status
        const prazoMin = calcularPrazoMinimo(items);
        const statusPrazo = getStatusPrazo(prazoMin);
        const textoPrazo = getTextoPrazo(statusPrazo);
        
        // NOVO: Calcula totais do card
        const totaisCard = calcularTotais(items);
        
        console.log(`üìä OC ${ocInfo.ordCompra}: Prazo m√≠nimo = ${prazoMin}, Status = ${statusPrazo}, Metros = ${totaisCard.metros}, Pares = ${totaisCard.pares}`);

        let headerHtml = `
            <div class="card-header">
                ${statusPrazo ? `<span class="prazo-badge ${statusPrazo}">${textoPrazo}</span>` : ''}
                <h3>OC: ${ocInfo.ordCompra} | ${ocInfo.cliente || 'Sem cliente'}</h3>`;
        
        // NOVO: Adiciona totalizador do card
        if (totaisCard.metros > 0 || totaisCard.pares > 0) {
            headerHtml += `<div class="card-totals">`;
            if (totaisCard.metros > 0) {
                headerHtml += `<div class="card-total-item">
                    <span class="card-total-label">Metros:</span>
                    <span class="card-total-value">${fmtInt(totaisCard.metros)}</span>
                </div>`;
            }
            if (totaisCard.pares > 0) {
                headerHtml += `<div class="card-total-item">
                    <span class="card-total-label">Pares:</span>
                    <span class="card-total-value">${fmtInt(totaisCard.pares)}</span>
                </div>`;
            }
            headerHtml += `</div>`;
        }
        
        headerHtml += `</div>`;
        
        if (hasFaturadosItems) {
            headerHtml += `<div class="card-message">ITEM FATURADO AGUARDANDO FINALIZAR</div>`;
        }

        let bodyHtml = '';
        
        if (items.length > 0) {
            bodyHtml = `<div class="overflow-x-auto"><table class="item-table"><thead><tr>
                            ${hasInactiveItems ? '<th class="checkbox-cell"></th>' : ''}
                            <th>Cartela</th><th>C√≥d. Cliente</th><th class="description-col">Descri√ß√£o</th>
                            <th>Tamanho</th><th>Qtd. Aberta</th><th>OS</th><th>Progresso</th>
                            <th>Dt. Recebimento</th><th>Dt. Entrega</th><th class="status-prazo">Prazo</th>
                            <th>A√ß√µes</th></tr></thead><tbody>`;
            
            items.forEach(item => {
                if (!item) return;
                const itemStatusClass = `item-${(item.Status || 'desconhecido').toLowerCase()}`;
                const itemId = `item-linha-${item.planilhaLinha}`;
                const isInactive = item.Status === 'Inativo';
                const isFaturado = item.Status === 'Faturado';

                const qtdOriginal = item['QTD. ORIGINAL'] || item['QTD. ABERTA'] || 0;
                const qtdAberta = item['QTD. ABERTA'] || 0;
                const percentRestante = qtdOriginal > 0 ? Math.round((qtdAberta / qtdOriginal) * 100) : 0;
                const progressColor = percentRestante >= 70 ? 'verde' : (percentRestante >= 30 ? 'amarelo' : (percentRestante >= 10 ? 'laranja' : 'vermelho'));
                const progressFull = percentRestante === 100 ? ' full' : '';

                bodyHtml += `<tr id="${itemId}" class="${itemStatusClass}" data-unique-id="${item.uniqueId}" data-linha="${item.planilhaLinha}" data-oc="${ocInfo.ordCompra}" data-item-desc="${item.DESCRI√á√ÉO || 'N/A'}" data-item-qtd="${item['QTD. ABERTA'] || 0}" data-item-tamanho="${item.TAMANHO || 'N/A'}">`;

                if (hasInactiveItems) {
                    if (isInactive) {
                        bodyHtml += `<td class="checkbox-cell"><input type="checkbox" class="item-checkbox" onchange="updateGlobalSelectedCount()"></td>`;
                    } else {
                        bodyHtml += `<td class="checkbox-cell"></td>`;
                    }
                }

                bodyHtml += `
                        <td class="nowrap">${item.CARTELA ?? 'N/A'}</td>
                        <td class="nowrap">${item['C√ìD. CLIENTE'] ?? 'N/A'}</td>
                        <td class="description-col">${item.DESCRI√á√ÉO ?? 'N/A'}</td>
                        <td class="nowrap">${item.TAMANHO ?? 'N/A'}</td>
                        <td class="nowrap">${fmtInt(qtdAberta)}</td>
                        <td class="nowrap">${item['C√ìD. OS'] ?? 'N/A'}</td>
                        <td class="nowrap">
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill ${progressColor}${progressFull}" style="width: ${percentRestante}%"></div>
                                <div class="progress-text">${percentRestante}%</div>
                            </div>
                        </td>
                        <td class="nowrap">${formatarData(item['DATA RECEB.'])}</td>
                        <td class="nowrap">${formatarData(item['DT. ENTREGA'])}</td>
                        <td class="status-prazo nowrap">${item.PRAZO ?? 'N/A'}</td>
                        <td class="nowrap">`;

                // Bot√£o de Baixa Parcial (para itens Ativos) + Bot√£o Finalizado (para itens Faturados)
                if (!isFaturado && !isInactive) {
                    bodyHtml += `<button class="btn-baixa" onclick='handleBaixa(${JSON.stringify(item).replace(/'/g, "&apos;")})'>üì¶ Baixa</button>`;
                } else if (isFaturado) {
                    const disabled = hasInactiveItems ? 'disabled' : '';
                    const title = hasInactiveItems ? 'Marque os itens inativos como faturados primeiro' : 'Finalizar item';
                    bodyHtml += `<button class="btn-finalizar" ${disabled} title="${title}" onclick="handleFinalizar('${item.uniqueId}', ${item.planilhaLinha}, '${cardId}')">Finalizado</button>`;
                } else {
                    bodyHtml += '-';
                }

                bodyHtml += `</td></tr>`;
            });
            bodyHtml += `</tbody></table></div>`;
        } else if (itemResponse && itemResponse.ok === false) {
            const errorMsg = itemResponse.error ? (itemResponse.error.message || JSON.stringify(itemResponse.error)) : 'Erro desconhecido';
            bodyHtml = `<div class="card-body error">Erro ao carregar itens: ${errorMsg}</div>`;
        } else {
            bodyHtml = `<div class="card-body loading">Nenhum item encontrado para esta OC.</div>`;
        }

        card.innerHTML = headerHtml + `<div class="card-body">${bodyHtml}</div>`;
        
        if (!existingCard) { 
            $cardsContainer.appendChild(card); 
        }
    }
    
    function updateStats() {
      if (!$stats) {
        console.warn('‚ö†Ô∏è Elemento #stats n√£o encontrado');
        return;
      }
      const totalOcs = FILTERED_OCS_INFO.length;
      const cardsRendered = $cardsContainer.querySelectorAll('.card').length;
      $stats.textContent = `Exibindo ${cardsRendered} de ${totalOcs} OCs.`;
    }
    
    // NOVO: Atualiza totalizadores gerais
    function updateTotaisGerais() {
        let totalMetros = 0;
        let totalPares = 0;
        
        // Percorre todos os cards vis√≠veis
        FILTERED_OCS_INFO.forEach(ocInfo => {
            const itemResponse = ALL_OCS_ITEMS[ocInfo.ordCompra];
            if (itemResponse && itemResponse.ok && itemResponse.items) {
                const items = itemResponse.items.filter(item => item.Status !== 'Excluido');
                const totais = calcularTotais(items);
                totalMetros += totais.metros;
                totalPares += totais.pares;
            }
        });
        
        $totalMetros.textContent = fmtInt(totalMetros);
        $totalPares.textContent = fmtInt(totalPares);
        
        console.log(`üìä Totais gerais atualizados: ${totalMetros} metros, ${totalPares} pares`);
    }

    function updateGlobalSelectedCount() {
        const checkboxes = document.querySelectorAll('.item-checkbox:checked');
        const count = checkboxes.length;
        
        $selectedCount.textContent = `${count} item${count !== 1 ? 'ns' : ''} selecionado${count !== 1 ? 's' : ''}`;
        
        $btnFaturarGlobal.disabled = count === 0;
        $btnExcluirGlobal.disabled = count === 0;
    }
    
    function updateInactiveRowsList() {
        allInactiveRows = Array.from(document.querySelectorAll('tr.item-inativo'));
        currentKeyboardIndex = -1;
        console.log(`üìã Lista de linhas inativas atualizada: ${allInactiveRows.length} itens`);
    }
    
    function updateVisibleRows() {
        allVisibleRows = Array.from(document.querySelectorAll('.item-table tbody tr'));
        currentRowIndex = -1;
        console.log(`üìã Lista de linhas vis√≠veis atualizada: ${allVisibleRows.length} itens`);
    }
    
    function updateInactiveCount() {
        const count = document.querySelectorAll('tr.item-inativo').length;
        totalInactiveItems = count;
        console.log(`üìä Total de itens inativos: ${totalInactiveItems}`);
        return totalInactiveItems;
    }
    
    // Reordena cards: Inativos ‚Üí Faturados ‚Üí Normais
    function reorderCards() {
  console.log('üîÑ Reordenando cards...');

  const cards = Array.from($cardsContainer.querySelectorAll('.card')).map(card => {
    const hasInativos  = card.querySelectorAll('.item-inativo').length > 0;
    const hasFaturados = card.classList.contains('has-pending-faturados');

    // menor prazo entre as linhas vis√≠veis do card
    let prazoMin = Infinity;
    card.querySelectorAll('td.status-prazo').forEach(td => {
      const n = parseInt((td.textContent || '').trim(), 10);
      if (!isNaN(n)) prazoMin = Math.min(prazoMin, n);
    });
    const prazoKey  = (prazoMin === Infinity) ? Infinity : prazoMin;
    const groupRank = hasInativos ? 0 : (hasFaturados ? 1 : 2);
    const ocKey     = (card.id || '').replace(/^card-/, '');

    return { card, groupRank, prazoKey, ocKey };
  });

  cards.sort((a, b) => {
    if (a.groupRank !== b.groupRank) return a.groupRank - b.groupRank;
    if (a.prazoKey !== b.prazoKey)   return a.prazoKey - b.prazoKey;
    return a.ocKey.localeCompare(b.ocKey, 'pt-BR', { numeric: true, sensitivity: 'base' });
  });

  // reapenda na nova ordem
  const frag = document.createDocumentFragment();
  cards.forEach(c => frag.appendChild(c.card));
  $cardsContainer.innerHTML = '';
  $cardsContainer.appendChild(frag);

  updateTotaisGerais();
  updateStats();
}

    // ==== MODAIS ====
    
    function showWarningModal() {
        $warningInactiveCount.textContent = totalInactiveItems;
        
        // Preenche lista de itens inativos
        const inactiveItems = [];
        document.querySelectorAll('tr.item-inativo').forEach(row => {
            const desc = row.dataset.itemDesc || 'Item';
            const qtd = row.dataset.itemQtd || '0';
            const tamanho = row.dataset.itemTamanho || '';
            const oc = row.dataset.oc || '';
            inactiveItems.push(`OC ${oc} - ${formatItemInfo(desc, tamanho, qtd)}`);
        });
        
        $warningItemList.innerHTML = inactiveItems.map(item => 
            `<li>${item}</li>`
        ).join('');
        
        $warningModal.classList.remove('hidden');
    }

    function closeWarningModal() {
        $warningModal.classList.add('hidden');
    }
    
    function toggleInactiveList() {
        $warningItemList.classList.toggle('visible');
    }

    function showDeleteAllModal() {
        // Coleta todos os itens inativos
        const allInactiveItems = [];
        
        document.querySelectorAll('tr.item-inativo').forEach(row => {
            const desc = row.dataset.itemDesc || 'Item';
            const qtd = row.dataset.itemQtd || '0';
            const tamanho = row.dataset.itemTamanho || '';
            const oc = row.dataset.oc || '';
            allInactiveItems.push({
                uniqueId: row.dataset.uniqueId,
                linha: parseInt(row.dataset.linha),
                info: `OC ${oc} - ${formatItemInfo(desc, tamanho, qtd)}`
            });
        });
        
        console.log(`üóëÔ∏è Preparando exclus√£o em massa de ${allInactiveItems.length} itens`);
        
        // Preenche lista
        $deleteAllList.innerHTML = allInactiveItems.map(item => 
            `<li>‚úó ${item.info}</li>`
        ).join('');
        
        // Guarda dados
        $deleteAllModal.dataset.items = JSON.stringify(allInactiveItems);
        
        // Mostra modal
        closeWarningModal();
        $deleteAllModal.classList.remove('hidden');
    }
    
    function showExcluirGlobalModal() {
        // Coleta apenas os itens MARCADOS para exclus√£o
        const selectedItems = [];
        
        document.querySelectorAll('.item-checkbox:checked').forEach(checkbox => {
            const row = checkbox.closest('tr');
            const desc = row.dataset.itemDesc || 'Item';
            const qtd = row.dataset.itemQtd || '0';
            const tamanho = row.dataset.itemTamanho || '';
            const oc = row.dataset.oc || '';
            selectedItems.push({
                uniqueId: row.dataset.uniqueId,
                linha: parseInt(row.dataset.linha),
                info: `OC ${oc} - ${formatItemInfo(desc, tamanho, qtd)}`
            });
        });
        
        if (selectedItems.length === 0) {
            alert('Nenhum item selecionado para excluir.');
            return;
        }
        
        console.log(`üóëÔ∏è Preparando exclus√£o de ${selectedItems.length} itens selecionados`);
        
        // Preenche lista
        $deleteAllList.innerHTML = selectedItems.map(item => 
            `<li>‚úó ${item.info}</li>`
        ).join('');
        
        // Guarda dados
        $deleteAllModal.dataset.items = JSON.stringify(selectedItems);
        
        // Mostra modal
        $deleteAllModal.classList.remove('hidden');
    }

    function hideDeleteAllModal() {
        $deleteAllModal.classList.add('hidden');
    }

    function confirmDeleteAll() {
        const items = JSON.parse($deleteAllModal.dataset.items || '[]');
        
        if (items.length === 0) {
            alert('Nenhum item para excluir.');
            hideDeleteAllModal();
            return;
        }
        
        console.log(`üóëÔ∏è Confirmando exclus√£o de ${items.length} itens...`);
        
        hideDeleteAllModal();
        $loader.classList.remove('hidden');
        $loadingText.textContent = 'Excluindo itens...';
        
        google.script.run
            .withSuccessHandler(result => {
                console.log('‚úÖ Resultado da exclus√£o em massa:', result);
                $loader.classList.add('hidden');
                
                if (result.success) {
                    // Remove itens da visualiza√ß√£o
                    items.forEach(item => {
                        const row = document.getElementById(`item-linha-${item.linha}`);
                        if (row) {
                            row.remove();
                        }
                    });
                    
                    // Remove cards vazios
                    document.querySelectorAll('.card').forEach(card => {
                        const rows = card.querySelectorAll('.item-table tbody tr');
                        if (rows.length === 0) {
                            card.remove();
                        }
                    });
                    
                    hideDeleteAllModal();
                    showSuccessModal(`${result.processados} item(ns) exclu√≠do(s) com sucesso!`);
                    updateStats();
                    updateInactiveRowsList();
                    updateInactiveCount();
                    reorderCards();
                } else {
                    alert('Erro ao excluir itens: ' + (result.error || 'Erro desconhecido'));
                }
            })
            .withFailureHandler(error => {
                console.error('‚ùå Erro ao excluir:', error);
                alert('Falha ao excluir itens: ' + error.message);
                $loader.classList.add('hidden');
            })
            .excluirMultiplosItens(items);
    }

    // ==== MODAL DE CONFIRMA√á√ÉO DE FATURAMENTO ====
    function showConfirmModal() {
        const allInactiveRows = document.querySelectorAll('tr.item-inativo');
        const itemsToFaturar = [];
        const itemsToExcluir = [];
        
        allInactiveRows.forEach(row => {
            const checkbox = row.querySelector('.item-checkbox');
            const desc = row.dataset.itemDesc || 'Item';
            const qtd = row.dataset.itemQtd || '0';
            const tamanho = row.dataset.itemTamanho || '';
            const itemInfo = formatItemInfo(desc, tamanho, qtd);
            
            if (checkbox && checkbox.checked) {
                itemsToFaturar.push({
                    uniqueId: row.dataset.uniqueId,
                    linha: parseInt(row.dataset.linha),
                    info: itemInfo
                });
            } else {
                itemsToExcluir.push({
                    uniqueId: row.dataset.uniqueId,
                    linha: parseInt(row.dataset.linha),
                    info: itemInfo
                });
            }
        });
        
        $modalFaturarList.innerHTML = itemsToFaturar.map(item => 
            `<li>‚úì ${item.info}</li>`
        ).join('');
        
        $modalExcluirList.innerHTML = itemsToExcluir.map(item => 
            `<li>‚úó ${item.info}</li>`
        ).join('');
        
        $confirmModal.classList.remove('hidden');
        
        $confirmModal.dataset.faturar = JSON.stringify(itemsToFaturar);
        $confirmModal.dataset.excluir = JSON.stringify(itemsToExcluir);
    }

    function hideConfirmModal() {
        $confirmModal.classList.add('hidden');
    }

    function confirmFaturamento() {
        const itemsToFaturar = JSON.parse($confirmModal.dataset.faturar || '[]');
        const itemsToExcluir = JSON.parse($confirmModal.dataset.excluir || '[]');
        let cardIds = new Set(); // Declarado aqui para ser acess√≠vel em ambos os blocos

        hideConfirmModal();

        console.log(`üí≥ Faturando ${itemsToFaturar.length} itens e excluindo ${itemsToExcluir.length} itens`);

        $btnFaturarGlobal.disabled = true;
        $btnFaturarGlobal.textContent = 'Processando...';

        google.script.run
            .withSuccessHandler(resultFaturar => {
                console.log('‚úÖ Resultado do faturamento:', resultFaturar);

                if (itemsToExcluir.length > 0) {
                    google.script.run
                        .withSuccessHandler(resultExcluir => {
                            console.log('‚úÖ Resultado da exclus√£o:', resultExcluir);
                            
                            itemsToFaturar.forEach(item => {
                                const row = document.getElementById(`item-linha-${item.linha}`);
                                if (row) {
                                    row.classList.remove('item-inativo');
                                    row.classList.add('item-faturado');
                                    const checkbox = row.querySelector('.item-checkbox');
                                    if (checkbox) {
                                        checkbox.closest('td').innerHTML = '';
                                    }
                                    cardIds.add(row.dataset.oc);

                                    // Atualiza os dados subjacentes em ALL_OCS_ITEMS
                                    const ocId = row.dataset.oc;
                                    const uniqueId = row.dataset.uniqueId;
                                    if (ALL_OCS_ITEMS[ocId] && ALL_OCS_ITEMS[ocId].items) {
                                        const itemData = ALL_OCS_ITEMS[ocId].items.find(i => i.uniqueId === uniqueId);
                                        if (itemData) {
                                            itemData.Status = 'Faturado';
                                            console.log(`‚úÖ Status atualizado em mem√≥ria: ${uniqueId} ‚Üí Faturado`);
                                        }
                                    }
                                }
                            });
                            
                            itemsToExcluir.forEach(item => {
                                const row = document.getElementById(`item-linha-${item.linha}`);
                                if (row) {
                                    row.remove();
                                }
                            });
                            
                            // Atualiza bot√µes Finalizado com base em inativos restantes
                            cardIds.forEach(ocId => {
                                const cardIdClean = "card-" + String(ocId).replace(/[^a-zA-Z0-9-]/g, '');
                                const card = document.getElementById(cardIdClean);
                                if (card) {
                                    // Verifica se ainda h√° inativos no card
                                    const hasInactives = card.querySelectorAll('.item-inativo').length > 0;
                                    
                                    // Atualiza bot√µes Finalizado
                                    card.querySelectorAll('.btn-finalizar').forEach(btn => {
                                        btn.disabled = hasInactives;
                                        btn.title = hasInactives ? 'Marque os itens inativos como faturados primeiro' : 'Finalizar item';
                                    });
                                    
                                    // Adiciona bot√£o para itens rec√©m faturados
                                    itemsToFaturar.forEach(item => {
                                        const row = document.getElementById(`item-linha-${item.linha}`);
                                        if (row && row.dataset.oc === ocId) {
                                            const acoesCell = row.querySelector('td:last-child');
                                            if (acoesCell && !acoesCell.querySelector('.btn-finalizar')) {
                                                const disabled = hasInactives ? 'disabled' : '';
                                                const title = hasInactives ? 'Marque os itens inativos como faturados primeiro' : 'Finalizar item';
                                                acoesCell.innerHTML = `<button class="btn-finalizar" ${disabled} title="${title}" onclick="handleFinalizar('${item.uniqueId}', ${item.linha}, '${cardIdClean}')">Finalizado</button>`;
                                            }
                                        }
                                    });
                                    
                                    card.classList.add('has-pending-faturados');
                                    if (!card.querySelector('.card-message')) {
                                        const header = card.querySelector('.card-header');
                                        const message = document.createElement('div');
                                        message.className = 'card-message';
                                        message.textContent = 'ITEM FATURADO AGUARDANDO FINALIZAR';
                                        header.after(message);
                                    }
                                    
                                    // NOVO: Recalcula totais do card
                                    const ocInfo = FILTERED_OCS_INFO.find(oc => oc.ordCompra === ocId);
                                    if (ocInfo) {
                                        const itemResponse = ALL_OCS_ITEMS[ocId];
                                        if (itemResponse && itemResponse.ok) {
                                            const items = itemResponse.items.filter(item => item.Status !== 'Excluido');
                                            const totaisCard = calcularTotais(items);
                                            
                                            // Atualiza o totalizador do card
                                            const cardTotals = card.querySelector('.card-totals');
                                            if (cardTotals) {
                                                let totalsHtml = '';
                                                if (totaisCard.metros > 0) {
                                                    totalsHtml += `<div class="card-total-item">
                                                        <span class="card-total-label">Metros:</span>
                                                        <span class="card-total-value">${fmtInt(totaisCard.metros)}</span>
                                                    </div>`;
                                                }
                                                if (totaisCard.pares > 0) {
                                                    totalsHtml += `<div class="card-total-item">
                                                        <span class="card-total-label">Pares:</span>
                                                        <span class="card-total-value">${fmtInt(totaisCard.pares)}</span>
                                                    </div>`;
                                                }
                                                cardTotals.innerHTML = totalsHtml;
                                            }
                                        }
                                    }
                                }
                            });
                            
                            hideConfirmModal();

                            // Atualiza contadores (mas n√£o mostra modal novamente)
                            updateGlobalSelectedCount();
                            updateInactiveRowsList();
                            updateInactiveCount();
                            reorderCards();

                            // Fecha modal de warning se estiver aberto
                            closeWarningModal();

                            // Mostra sucesso
                            showSuccessModal('Itens faturados aguardando finaliza√ß√£o na produ√ß√£o!');

                            $btnFaturarGlobal.disabled = false;
                            $btnFaturarGlobal.textContent = 'Faturado sem finalizar';
                            
                        })
                        .withFailureHandler(error => {
                            console.error('‚ùå Erro ao excluir:', error);
                            alert('Itens faturados com sucesso, mas erro ao excluir os n√£o marcados.');
                            $btnFaturarGlobal.disabled = false;
                            $btnFaturarGlobal.textContent = 'Faturado sem finalizar';
                        })
                        .excluirMultiplosItens(itemsToExcluir);
                } else {
                    // S√≥ faturamento, sem exclus√£o
                    itemsToFaturar.forEach(item => {
                        const row = document.getElementById(`item-linha-${item.linha}`);
                        if (row) {
                            row.classList.remove('item-inativo');
                            row.classList.add('item-faturado');
                            const checkbox = row.querySelector('.item-checkbox');
                            if (checkbox) {
                                checkbox.closest('td').innerHTML = '';
                            }
                            cardIds.add(row.dataset.oc);

                            // Atualiza os dados subjacentes em ALL_OCS_ITEMS
                            const ocId = row.dataset.oc;
                            const uniqueId = row.dataset.uniqueId;
                            if (ALL_OCS_ITEMS[ocId] && ALL_OCS_ITEMS[ocId].items) {
                                const itemData = ALL_OCS_ITEMS[ocId].items.find(i => i.uniqueId === uniqueId);
                                if (itemData) {
                                    itemData.Status = 'Faturado';
                                    console.log(`‚úÖ Status atualizado em mem√≥ria: ${uniqueId} ‚Üí Faturado`);
                                }
                            }
                        }
                    });

                    // Atualiza bot√µes e visual dos cards
                    cardIds.forEach(ocId => {
                        const cardIdClean = "card-" + String(ocId).replace(/[^a-zA-Z0-9-]/g, '');
                        const card = document.getElementById(cardIdClean);
                        if (card) {
                            const hasInactives = card.querySelectorAll('.item-inativo').length > 0;

                            card.querySelectorAll('.btn-finalizar').forEach(btn => {
                                btn.disabled = hasInactives;
                                btn.title = hasInactives ? 'Marque os itens inativos como faturados primeiro' : 'Finalizar item';
                            });

                            itemsToFaturar.forEach(item => {
                                const row = document.getElementById(`item-linha-${item.linha}`);
                                if (row && row.dataset.oc === ocId) {
                                    const acoesCell = row.querySelector('td:last-child');
                                    if (acoesCell && !acoesCell.querySelector('.btn-finalizar')) {
                                        const disabled = hasInactives ? 'disabled' : '';
                                        const title = hasInactives ? 'Marque os itens inativos como faturados primeiro' : 'Finalizar item';
                                        acoesCell.innerHTML = `<button class="btn-finalizar" ${disabled} title="${title}" onclick="handleFinalizar('${item.uniqueId}', ${item.linha}, '${cardIdClean}')">Finalizado</button>`;
                                    }
                                }
                            });

                            card.classList.add('has-pending-faturados');
                            if (!card.querySelector('.card-message')) {
                                const header = card.querySelector('.card-header');
                                const message = document.createElement('div');
                                message.className = 'card-message';
                                message.textContent = 'ITEM FATURADO AGUARDANDO FINALIZAR';
                                header.after(message);
                            }
                        }
                    });

                    hideConfirmModal();

                    // Atualiza contadores (mas n√£o mostra modal novamente)
                    updateGlobalSelectedCount();
                    updateInactiveRowsList();
                    updateInactiveCount();
                    reorderCards();

                    // Fecha modal de warning se estiver aberto
                    closeWarningModal();

                    // Mostra sucesso
                    showSuccessModal('Itens faturados aguardando finaliza√ß√£o na produ√ß√£o!');

                    $btnFaturarGlobal.disabled = false;
                    $btnFaturarGlobal.textContent = 'Faturado sem finalizar';
                }
            })
            .withFailureHandler(error => {
                console.error('‚ùå Erro ao faturar:', error);
                alert('Falha ao faturar itens: ' + error.message);
                $btnFaturarGlobal.disabled = false;
                $btnFaturarGlobal.textContent = 'Faturar';
            })
            .marcarMultiplosFaturados(itemsToFaturar);
    }

    function handleBaixa(item) {
        console.log('üì¶ Abrindo modal de baixa para:', item);
        showBaixaModal(item);
    }

    function handleFinalizar(uniqueId, linha, cardId) {
        if (!confirm('Finalizar este item?')) {
            return;
        }

        console.log(`‚úÖ Finalizando item ${uniqueId} (linha ${linha})`);

        google.script.run
            .withSuccessHandler(result => {
                console.log('‚úÖ Resultado da finaliza√ß√£o:', result);
                if (result.success) {
                    const row = document.getElementById(`item-linha-${linha}`);
                    if (row) {
                        row.remove();
                    }
                    
                    const card = document.getElementById(cardId);
                    if (card) {
                        const remainingRows = card.querySelectorAll('.item-table tbody tr').length;
                        if (remainingRows === 0) {
                            card.remove();
                        } else {
                            const remainingFaturados = card.querySelectorAll('.item-faturado').length;
                            if (remainingFaturados === 0) {
                                card.classList.remove('has-pending-faturados');
                                const message = card.querySelector('.card-message');
                                if (message) {
                                    message.remove();
                                }
                            }
                            
                            // Atualiza estado dos bot√µes Finalizado
                            const hasInactives = card.querySelectorAll('.item-inativo').length > 0;
                            card.querySelectorAll('.btn-finalizar').forEach(btn => {
                                btn.disabled = hasInactives;
                                btn.title = hasInactives ? 'Marque os itens inativos como faturados primeiro' : 'Finalizar item';
                            });
                        }
                    }
                    
                    updateInactiveCount();
                    reorderCards();
                    alert('‚úÖ Item finalizado!');
                } else {
                    alert('Erro ao finalizar item: ' + (result.error || 'Erro desconhecido'));
                }
            })
            .withFailureHandler(error => {
                console.error('‚ùå Erro ao finalizar:', error);
                alert('Falha ao finalizar item: ' + error.message);
            })
            .finalizarItem(uniqueId, linha);
    }
    
    function showSuccessModal(message) {
        $successMessage.textContent = message;
        $successModal.classList.remove('hidden');
    }
    
    function hideSuccessModal() {
        $successModal.classList.add('hidden');
    }

    // ==== MODAL DE BAIXA PARCIAL ====

    function getProgressColor(percentRestante) {
        if (percentRestante >= 70) return 'verde';
        if (percentRestante >= 30) return 'amarelo';
        if (percentRestante >= 10) return 'laranja';
        return 'vermelho';
    }

    function updateProgressBar(qtdOriginal, qtdAberta) {
        const percentRestante = qtdOriginal > 0 ? Math.round((qtdAberta / qtdOriginal) * 100) : 0;
        const color = getProgressColor(percentRestante);

        $baixaProgressBar.style.width = percentRestante + '%';
        $baixaProgressBar.className = 'progress-bar-fill ' + color + (percentRestante === 100 ? ' full' : '');
        $baixaProgressText.textContent = percentRestante + '%';
    }

    function showBaixaModal(item) {
        currentBaixaItem = item;

        const qtdOriginal = item['QTD. ORIGINAL'] || item['QTD. ABERTA'] || 0;
        const qtdAberta = item['QTD. ABERTA'] || 0;
        const desc = item['DESCRI√á√ÉO'] || 'N/A';
        const tamanho = item.TAMANHO || '';
        const unidade = getUnidade(tamanho);

        $baixaQtdOriginal.textContent = fmtInt(qtdOriginal);
        $baixaQtdAberta.textContent = fmtInt(qtdAberta);
        $baixaMaxQtd.textContent = fmtInt(qtdAberta);
        $baixaItemDesc.textContent = formatItemInfo(desc, tamanho, qtdAberta);

        updateProgressBar(qtdOriginal, qtdAberta);

        // Limpa input
        $novaBaixaInput.value = '';
        $editarBaixaForm.style.display = 'none';

        // Carrega hist√≥rico
        carregarHistorico(item.uniqueId);

        $baixaModal.classList.remove('hidden');
    }

    function hideBaixaModal() {
        $baixaModal.classList.add('hidden');
        currentBaixaItem = null;
    }

    function carregarHistorico(uniqueId) {
        console.log(`üìã Carregando hist√≥rico para ${uniqueId}`);

        google.script.run
            .withSuccessHandler(result => {
                console.log('‚úÖ Hist√≥rico recebido (RAW):', result);
                console.log('   - Tipo:', typeof result);
                console.log('   - √â null?', result === null);
                console.log('   - √â undefined?', result === undefined);

                // Sempre mostra a se√ß√£o de hist√≥rico
                $historicoSection.style.display = 'block';

                // Prote√ß√£o contra null/undefined
                if (!result) {
                    console.warn('‚ö†Ô∏è Resultado null ou undefined! Exibindo hist√≥rico vazio.');
                    renderizarHistorico([]);
                    return;
                }

                console.log('   - Success:', result.success);
                console.log('   - Hist√≥rico length:', result.historico ? result.historico.length : 0);
                console.log('   - Hist√≥rico data:', result.historico);

                if (result.success && result.historico) {
                    console.log('   ‚Üí Renderizando hist√≥rico...');
                    renderizarHistorico(result.historico);
                    console.log('   ‚Üí Hist√≥rico exibido!');
                } else {
                    console.log('   ‚Üí Erro ao carregar hist√≥rico ou hist√≥rico vazio');
                    renderizarHistorico([]);
                }
            })
            .withFailureHandler(error => {
                console.error('‚ùå Erro ao carregar hist√≥rico:', error);
                // Ainda mostra a se√ß√£o, mas vazia
                $historicoSection.style.display = 'block';
                renderizarHistorico([]);
            })
            .obterHistoricoBaixas(uniqueId);
    }

    function renderizarHistorico(historico) {
        $historicoCount.textContent = `${historico.length} registro${historico.length !== 1 ? 's' : ''}`;

        if (!historico || historico.length === 0) {
            $historicoList.innerHTML = '<div style="padding: 1rem; text-align: center; color: #9ca3af; font-size: 0.875rem;">Nenhuma baixa registrada ainda</div>';
            return;
        }

        let html = '';
        historico.forEach((h, index) => {
            const isUltima = index === historico.length - 1;
            const className = isUltima ? 'historico-item ultima' : 'historico-item';

            html += `
                <div class="${className}">
                    <div class="historico-item-info">
                        <span class="historico-item-qtd">-${fmtInt(h.qtdBaixada)}</span>
                        <span class="historico-item-data">${h.dataHoraFormatada || ''}</span>
                    </div>
                    ${isUltima ? `<div class="historico-item-actions"><button class="btn-editar-baixa" onclick="window.mostrarEdicaoBaixa(${h.qtdBaixada})">‚úèÔ∏è Editar</button></div>` : ''}
                </div>
            `;
        });

        $historicoList.innerHTML = html;
    }

    function mostrarEdicaoBaixa(qtdBaixadaAtual) {
        $editarBaixaAtual.textContent = '-' + fmtInt(qtdBaixadaAtual);
        $editarBaixaInput.value = '';
        $editarBaixaForm.style.display = 'block';
        $novaBaixaSection.style.display = 'none';
        $editarBaixaInput.focus();
    }

    // Exp√µe a fun√ß√£o globalmente para uso no onclick
    window.mostrarEdicaoBaixa = mostrarEdicaoBaixa;

    function esconderEdicaoBaixa() {
        $editarBaixaForm.style.display = 'none';
        $novaBaixaSection.style.display = 'block';
    }

    function salvarEdicaoBaixa() {
        if (!currentBaixaItem) {
            alert('Erro: Item n√£o encontrado');
            return;
        }

        const input = $editarBaixaInput.value.trim();
        if (!input) {
            alert('Digite uma quantidade v√°lida');
            return;
        }

        let novaQtdBaixada;

        if (input.startsWith('+')) {
            // Reverter: +10 significa adicionar 10 √† quantidade aberta
            const reverter = parseInt(input.substring(1), 10);
            if (isNaN(reverter) || reverter <= 0) {
                alert('Quantidade inv√°lida para reverter');
                return;
            }

            const qtdBaixadaAtual = parseInt($editarBaixaAtual.textContent.replace('-', '').replace(/\./g, ''), 10);
            novaQtdBaixada = qtdBaixadaAtual - reverter;

            if (novaQtdBaixada < 0) {
                alert('N√£o √© poss√≠vel reverter mais do que foi baixado');
                return;
            }
        } else {
            // Substituir quantidade
            novaQtdBaixada = parseInt(input, 10);
            if (isNaN(novaQtdBaixada) || novaQtdBaixada <= 0) {
                alert('Digite uma quantidade v√°lida');
                return;
            }
        }

        console.log(`‚úèÔ∏è Editando √∫ltima baixa: ${currentBaixaItem.uniqueId} ‚Üí ${novaQtdBaixada}`);

        $salvarEdicaoBtn.disabled = true;
        $salvarEdicaoBtn.textContent = 'Salvando...';

        google.script.run
            .withSuccessHandler(result => {
                console.log('‚úÖ Edi√ß√£o salva:', result);

                if (result.success) {
                    // Atualiza a quantidade aberta no item
                    currentBaixaItem['QTD. ABERTA'] = result.novaQtdRestante;

                    // Atualiza modal
                    $baixaQtdAberta.textContent = fmtInt(result.novaQtdRestante);
                    $baixaMaxQtd.textContent = fmtInt(result.novaQtdRestante);
                    updateProgressBar(currentBaixaItem['QTD. ORIGINAL'], result.novaQtdRestante);

                    // Atualiza a linha na tabela
                    const row = document.getElementById(`item-linha-${currentBaixaItem.planilhaLinha}`);
                    if (row) {
                        const cells = row.querySelectorAll('td');
                        const hasCheckbox = cells[0] && cells[0].querySelector('.item-checkbox');
                        const offset = hasCheckbox ? 1 : 0;

                        // Coluna QTD. ABERTA: Cartela(0), C√≥d(1), Desc(2), Tam(3), Original(4), Aberta(5)
                        const qtdAbertaCell = cells[5 + offset];
                        if (qtdAbertaCell) {
                            qtdAbertaCell.textContent = fmtInt(result.novaQtdRestante);
                        }

                        // Coluna Progresso: √≠ndice 6 + offset
                        const progressCell = cells[6 + offset];
                        if (progressCell) {
                            const qtdOriginal = currentBaixaItem['QTD. ORIGINAL'] || currentBaixaItem['QTD. ABERTA'] || 0;
                            const percentRestante = qtdOriginal > 0 ? Math.round((result.novaQtdRestante / qtdOriginal) * 100) : 0;
                            const progressColor = percentRestante >= 70 ? 'verde' : (percentRestante >= 30 ? 'amarelo' : (percentRestante >= 10 ? 'laranja' : 'vermelho'));
                            const progressFull = percentRestante === 100 ? ' full' : '';

                            progressCell.innerHTML = `
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill ${progressColor}${progressFull}" style="width: ${percentRestante}%"></div>
                                    <div class="progress-text">${percentRestante}%</div>
                                </div>
                            `;
                        }
                    }

                    // Atualiza totalizadores gerais
                    updateTotaisGerais();

                    // Recarrega hist√≥rico
                    carregarHistorico(currentBaixaItem.uniqueId);

                    esconderEdicaoBaixa();
                    alert('‚úÖ Baixa editada com sucesso!');
                } else {
                    alert('Erro ao editar baixa: ' + (result.error || 'Erro desconhecido'));
                }

                $salvarEdicaoBtn.disabled = false;
                $salvarEdicaoBtn.textContent = 'Salvar';
            })
            .withFailureHandler(error => {
                console.error('‚ùå Erro ao editar baixa:', error);
                alert('Falha ao editar baixa: ' + error.message);
                $salvarEdicaoBtn.disabled = false;
                $salvarEdicaoBtn.textContent = 'Salvar';
            })
            .editarUltimaBaixa(currentBaixaItem.uniqueId, currentBaixaItem.planilhaLinha, novaQtdBaixada);
    }

    function aplicarNovaBaixa() {
        if (!currentBaixaItem) {
            alert('Erro: Item n√£o encontrado');
            return;
        }

        const input = $novaBaixaInput.value.trim();
        if (!input) {
            alert('Digite uma quantidade');
            return;
        }

        let qtdBaixa;

        if (input.startsWith('+')) {
            // Aumentar: +10 significa adicionar 10 √† quantidade aberta (reverter baixa)
            const aumentar = parseInt(input.substring(1), 10);
            if (isNaN(aumentar) || aumentar <= 0) {
                alert('Quantidade inv√°lida');
                return;
            }

            // Para aumentar, usamos o bot√£o Editar no hist√≥rico
            alert('‚ö†Ô∏è Para reverter/aumentar quantidade:\n\n1. Veja o "üìã Hist√≥rico de Baixas" acima\n2. Clique no bot√£o "‚úèÔ∏è Editar" da √∫ltima baixa\n3. Digite +' + aumentar + ' para reverter\n\nSe n√£o houver hist√≥rico, fa√ßa uma baixa primeiro.');
            return;
        } else {
            // Baixa normal
            qtdBaixa = parseInt(input, 10);
            if (isNaN(qtdBaixa) || qtdBaixa <= 0) {
                alert('Digite uma quantidade v√°lida');
                return;
            }

            const qtdAberta = currentBaixaItem['QTD. ABERTA'] || 0;
            if (qtdBaixa > qtdAberta) {
                alert(`Quantidade de baixa (${qtdBaixa}) maior que dispon√≠vel (${qtdAberta})`);
                return;
            }
        }

        console.log(`üì¶ Aplicando baixa: ${currentBaixaItem.uniqueId} ‚Üí -${qtdBaixa}`);

        $baixaConfirmBtn.disabled = true;
        $baixaConfirmBtn.textContent = 'Processando...';

        google.script.run
            .withSuccessHandler(result => {
                console.log('‚úÖ Baixa aplicada:', result);

                if (result.success) {
                    console.log('‚úÖ Baixa aplicada com sucesso! Recarregando hist√≥rico...');
                    // Atualiza item
                    currentBaixaItem['QTD. ABERTA'] = result.novaQtd;

                    // Atualiza modal
                    $baixaQtdAberta.textContent = fmtInt(result.novaQtd);
                    $baixaMaxQtd.textContent = fmtInt(result.novaQtd);
                    updateProgressBar(currentBaixaItem['QTD. ORIGINAL'], result.novaQtd);

                    // Recarrega hist√≥rico
                    console.log(`üîÑ Chamando carregarHistorico("${currentBaixaItem.uniqueId}")`);
                    carregarHistorico(currentBaixaItem.uniqueId);

                    // Limpa input
                    $novaBaixaInput.value = '';

                    if (result.zerou) {
                        alert('‚úÖ Baixa aplicada! Item zerado e marcado como Faturado.');
                        hideBaixaModal();
                        // Recarrega a p√°gina
                        location.reload();
                    } else {
                        alert('‚úÖ Baixa aplicada com sucesso!');

                        // Atualiza a linha na tabela
                        const row = document.getElementById(`item-linha-${currentBaixaItem.planilhaLinha}`);
                        if (row) {
                            // Atualiza QTD. ABERTA
                            const cells = row.querySelectorAll('td');
                            const hasCheckbox = cells[0] && cells[0].querySelector('.item-checkbox');
                            const offset = hasCheckbox ? 1 : 0;

                            // Coluna QTD. ABERTA: Cartela(0), C√≥d(1), Desc(2), Tam(3), Original(4), Aberta(5)
                            const qtdAbertaCell = cells[5 + offset];
                            if (qtdAbertaCell) {
                                qtdAbertaCell.textContent = fmtInt(result.novaQtd);
                            }

                            // Coluna Progresso: √≠ndice 6 + offset
                            const progressCell = cells[6 + offset];
                            if (progressCell) {
                                const qtdOriginal = currentBaixaItem['QTD. ORIGINAL'] || currentBaixaItem['QTD. ABERTA'] || 0;
                                const percentRestante = qtdOriginal > 0 ? Math.round((result.novaQtd / qtdOriginal) * 100) : 0;
                                const progressColor = percentRestante >= 70 ? 'verde' : (percentRestante >= 30 ? 'amarelo' : (percentRestante >= 10 ? 'laranja' : 'vermelho'));
                                const progressFull = percentRestante === 100 ? ' full' : '';

                                progressCell.innerHTML = `
                                    <div class="progress-bar-container">
                                        <div class="progress-bar-fill ${progressColor}${progressFull}" style="width: ${percentRestante}%"></div>
                                        <div class="progress-text">${percentRestante}%</div>
                                    </div>
                                `;
                            }
                        }

                        // Atualiza totalizadores gerais
                        updateTotaisGerais();
                    }
                } else {
                    alert('Erro ao aplicar baixa: ' + (result.error || 'Erro desconhecido'));
                }

                $baixaConfirmBtn.disabled = false;
                $baixaConfirmBtn.textContent = 'Adicionar Baixa';
            })
            .withFailureHandler(error => {
                console.error('‚ùå Erro ao aplicar baixa:', error);
                alert('Falha ao aplicar baixa: ' + error.message);
                $baixaConfirmBtn.disabled = false;
                $baixaConfirmBtn.textContent = 'Adicionar Baixa';
            })
            .aplicarBaixa(currentBaixaItem.uniqueId, currentBaixaItem.planilhaLinha, qtdBaixa);
    }

    // ==== NAVEGA√á√ÉO POR TECLADO ====
    function moveRowSelection(direction) {
        if (allVisibleRows.length === 0) return;
        
        if (currentRowIndex >= 0 && currentRowIndex < allVisibleRows.length) {
            allVisibleRows[currentRowIndex].classList.remove('keyboard-selected');
        }
        
        if (direction > 0) {
            currentRowIndex = (currentRowIndex + 1) % allVisibleRows.length;
        } else {
            currentRowIndex = currentRowIndex <= 0 ? allVisibleRows.length - 1 : currentRowIndex - 1;
        }
        
        const currentRow = allVisibleRows[currentRowIndex];
        currentRow.classList.add('keyboard-selected');
        currentRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function clearRowSelection() {
        allVisibleRows.forEach(row => row.classList.remove('keyboard-selected'));
        currentRowIndex = -1;
    }

    function clearAllSelections() {
        document.querySelectorAll('.item-checkbox:checked').forEach(cb => cb.checked = false);
        updateGlobalSelectedCount();
        allInactiveRows.forEach(row => row.classList.remove('keyboard-focus'));
        currentKeyboardIndex = -1;
    }

    // ==== EVENT LISTENERS ====
    
    // Fechar autocomplete ao clicar fora
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.filter-wrapper')) {
            hideAutocomplete();
        }
    });
    
    $filterStatus.addEventListener('change', aplicarFiltros);
    $filterPrazo.addEventListener('change', aplicarFiltros);
    $refreshButton.addEventListener('click', () => carregarListaOcs(true));
    $btnFaturarGlobal.addEventListener('click', showConfirmModal);
    $btnExcluirGlobal.addEventListener('click', showExcluirGlobalModal);
    $modalConfirmBtn.addEventListener('click', confirmFaturamento);
    $modalCancelBtn.addEventListener('click', hideConfirmModal);
    
    // Modal de aviso
    $warningOkBtn.addEventListener('click', closeWarningModal);
    $warningDeleteBtn.addEventListener('click', showDeleteAllModal);
    
    // Modal de exclus√£o em massa
    $deleteAllConfirmBtn.addEventListener('click', confirmDeleteAll);
    $deleteAllCancelBtn.addEventListener('click', hideDeleteAllModal);
    
    // Modal de sucesso

    // Modal de baixa parcial
    $baixaConfirmBtn.addEventListener('click', aplicarNovaBaixa);
    $baixaCancelBtn.addEventListener('click', hideBaixaModal);
    $salvarEdicaoBtn.addEventListener('click', salvarEdicaoBaixa);
    $cancelarEdicaoBtn.addEventListener('click', esconderEdicaoBaixa);

    // Keyboard navigation - ‚Üë‚Üì entre itens (linhas)
    document.addEventListener('keydown', (e) => {
        if (!$confirmModal.classList.contains('hidden') || 
            !$warningModal.classList.contains('hidden') || 
            !$deleteAllModal.classList.contains('hidden') ||
            !$successModal.classList.contains('hidden') ||
            e.target.tagName === 'INPUT' ||
            e.target.tagName === 'SELECT') return;
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                moveRowSelection(1);
                break;
            case 'ArrowUp':
                e.preventDefault();
                moveRowSelection(-1);
                break;
            case 'Escape':
                e.preventDefault();
                clearRowSelection();
                break;
        }
    });

    // ==== RELAT√ìRIO DE PRODU√á√ÉO ====
    const $relatorioModal = document.getElementById('relatorioModal');
    const $btnRelatorioProducao = document.getElementById('btn-relatorio-producao');
    const $listaOcsRelatorio = document.getElementById('lista-ocs-relatorio');
    const $selecionarTodasOcs = document.getElementById('selecionar-todas-ocs');
    const $limparSelecaoOcs = document.getElementById('limpar-selecao-ocs');
    const $contadorOcsSelecionadas = document.getElementById('contador-ocs-selecionadas');
    const $relatorioCancelBtn = document.getElementById('relatorio-cancel-btn');
    const $relatorioGerarBtn = document.getElementById('relatorio-gerar-btn');

    let ocsSelecionadas = new Set();

    // Abrir modal de relat√≥rio
    $btnRelatorioProducao.addEventListener('click', function() {
        abrirModalRelatorio();
    });

    // Fechar modal
    $relatorioCancelBtn.addEventListener('click', function() {
        $relatorioModal.classList.add('hidden');
        ocsSelecionadas.clear();
    });

    // Selecionar todas
    $selecionarTodasOcs.addEventListener('click', function() {
        const checkboxes = $listaOcsRelatorio.querySelectorAll('input[type="checkbox"]:not(:disabled)');
        checkboxes.forEach(cb => {
            cb.checked = true;
            ocsSelecionadas.add(cb.value);
        });
        atualizarContadorOcs();
    });

    // Limpar sele√ß√£o
    $limparSelecaoOcs.addEventListener('click', function() {
        const checkboxes = $listaOcsRelatorio.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        ocsSelecionadas.clear();
        atualizarContadorOcs();
    });

    // Gerar relat√≥rio
    $relatorioGerarBtn.addEventListener('click', function() {
        if (ocsSelecionadas.size === 0) {
            alert('Selecione ao menos uma Ordem de Compra para gerar o relat√≥rio.');
            return;
        }
        gerarRelatorioProducao();
    });

    // Filtro de Marfim
    document.querySelectorAll('input[name="marfim-filter"]').forEach(radio => {
        radio.addEventListener('change', function() {
            popularListaOcsRelatorio();
        });
    });

    // Busca de OCs no modal
    const $buscaOcsRelatorio = document.getElementById('busca-ocs-relatorio');
    $buscaOcsRelatorio.addEventListener('input', function() {
        filtrarListaOcsRelatorio(this.value);
    });

    function abrirModalRelatorio() {
        popularListaOcsRelatorio();
        $relatorioModal.classList.remove('hidden');
        $buscaOcsRelatorio.value = '';
        $buscaOcsRelatorio.focus();
    }

    function filtrarListaOcsRelatorio(termo) {
        const busca = termo.toLowerCase().trim();
        const items = $listaOcsRelatorio.querySelectorAll('.oc-item-relatorio');

        items.forEach(item => {
            const texto = item.textContent.toLowerCase();
            if (texto.includes(busca)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function popularListaOcsRelatorio() {
        const marfimFilter = document.querySelector('input[name="marfim-filter"]:checked').value;
        ocsSelecionadas.clear();

        let html = '';

        FILTERED_OCS_INFO.forEach(oc => {
            const ocData = ALL_OCS_ITEMS[oc.ordCompra];
            if (!ocData || !ocData.items) return;

            // Filtrar por Marfim (CM/MM est√£o na coluna TAMANHO)
            let itensFiltrados = ocData.items;
            if (marfimFilter === 'cm') {
                itensFiltrados = ocData.items.filter(item => item.TAMANHO && item.TAMANHO.toUpperCase().includes('CM'));
            } else if (marfimFilter === 'mm') {
                itensFiltrados = ocData.items.filter(item => item.TAMANHO && item.TAMANHO.toUpperCase().includes('MM'));
            }

            if (itensFiltrados.length === 0) return;

            // Verificar se tem itens inativos ou faturados
            const temInativos = ocData.items.some(item => item.Status === 'Inativo');
            const temFaturados = ocData.items.some(item => item.Status === 'Faturado');

            let avisos = '';
            let estilo = '';

            if (temFaturados) {
                avisos += ' <span style="color: #dc2626; font-weight: 600;">‚ö†Ô∏è Tem Faturados</span>';
                estilo = 'background: #fef2f2; border-left: 4px solid #dc2626;';
            }
            if (temInativos) {
                avisos += ' <span style="color: #ea580c; font-weight: 600;">‚ö†Ô∏è Tem Inativos</span>';
            }

            html += `
                <div class="oc-item-relatorio" style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 0.5rem; ${estilo}">
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox" value="${oc.ordCompra}" class="oc-checkbox" style="width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #111827;">
                                OC: ${oc.ordCompra} - ${ocData.cliente || ''}
                            </div>
                            <div style="font-size: 0.875rem; color: #6b7280;">
                                ${itensFiltrados.length} ${itensFiltrados.length === 1 ? 'item' : 'itens'}${avisos}
                            </div>
                        </div>
                    </label>
                </div>
            `;
        });

        if (html === '') {
            html = '<div style="text-align: center; padding: 2rem; color: #6b7280;">Nenhuma OC dispon√≠vel com o filtro selecionado.</div>';
        }

        $listaOcsRelatorio.innerHTML = html;

        // Adicionar event listeners aos checkboxes
        $listaOcsRelatorio.querySelectorAll('.oc-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                if (this.checked) {
                    ocsSelecionadas.add(this.value);
                } else {
                    ocsSelecionadas.delete(this.value);
                }
                atualizarContadorOcs();
            });
        });

        atualizarContadorOcs();
    }

    function atualizarContadorOcs() {
        $contadorOcsSelecionadas.textContent = `${ocsSelecionadas.size} ${ocsSelecionadas.size === 1 ? 'OC selecionada' : 'OCs selecionadas'}`;
    }

    function gerarRelatorioProducao() {
        const marfimFilter = document.querySelector('input[name="marfim-filter"]:checked').value;

        // Criar janela de impress√£o
        const printWindow = window.open('', '_blank');

        let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Relat√≥rio de Produ√ß√£o</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { font-family: Arial, sans-serif; padding: 20px; font-size: 12px; }
                h1 { text-align: center; margin-bottom: 10px; font-size: 20px; }
                .info { text-align: center; margin-bottom: 20px; color: #666; font-size: 11px; }
                .oc-section { page-break-inside: avoid; margin-bottom: 30px; }
                .oc-header { background: #f3f4f6; padding: 10px; border: 2px solid #d1d5db; margin-bottom: 10px; }
                .oc-header.faturado-pending { background: #fef2f2; border-color: #dc2626; }
                .oc-title { font-size: 14px; font-weight: bold; margin-bottom: 5px; }
                .oc-avisos { color: #dc2626; font-weight: bold; font-size: 11px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
                th { background: #374151; color: white; padding: 8px 4px; text-align: left; font-size: 10px; border: 1px solid #111; }
                td { padding: 6px 4px; border: 1px solid #ddd; font-size: 10px; }
                tr:nth-child(even) { background: #f9fafb; }
                .status-Ativo { color: #059669; font-weight: bold; }
                .status-Inativo { color: #ea580c; font-weight: bold; }
                .status-Faturado { color: #dc2626; font-weight: bold; }
                @media print {
                    body { padding: 10px; }
                    .oc-section { page-break-inside: avoid; }
                }
            </style>
        </head>
        <body>
            <h1>üìÑ Relat√≥rio de Produ√ß√£o</h1>
            <div class="info">
                Gerado em: ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}<br>
                Filtro de Marfim: ${marfimFilter === 'all' ? 'Todos (CM + MM)' : marfimFilter === 'cm' ? 'Apenas CM' : 'Apenas MM'}
            </div>
        `;

        // MESMA ORDENA√á√ÉO DOS CARDS: preparar array com metadados
        const ocsParaRelatorio = [];

        ocsSelecionadas.forEach(ocNum => {
            const ocData = ALL_OCS_ITEMS[ocNum];
            if (!ocData || !ocData.items) return;

            const ocInfo = ALL_OCS_INFO.find(oc => oc.ordCompra === ocNum);
            const items = ocData.items.filter(i => i.Status !== 'Excluido');

            if (items.length === 0) return;

            // Calcular metadados (mesma l√≥gica dos cards)
            const hasInativos = items.some(i => i.Status === 'Inativo');
            const hasFaturados = items.some(i => i.Status === 'Faturado');
            const prazoMin = calcularPrazoMinimo(items);
            const prazoKey = (prazoMin === null || isNaN(prazoMin)) ? Infinity : prazoMin;
            const groupRank = hasInativos ? 0 : (hasFaturados ? 1 : 2);

            ocsParaRelatorio.push({
                ocNum,
                ocData,
                ocInfo,
                nomeCliente: ocInfo ? ocInfo.cliente : '',
                items,
                groupRank,
                prazoKey,
                ocKey: String(ocNum)
            });
        });

        // ORDENAR igual aos cards: grupo ‚Üí prazo ‚Üí OC
        ocsParaRelatorio.sort((a, b) => {
            if (a.groupRank !== b.groupRank) return a.groupRank - b.groupRank;
            if (a.prazoKey !== b.prazoKey) return a.prazoKey - b.prazoKey;
            return a.ocKey.localeCompare(b.ocKey, 'pt-BR', { numeric: true, sensitivity: 'base' });
        });

        // Processar cada OC na ordem correta
        ocsParaRelatorio.forEach(({ ocNum, ocData, ocInfo, nomeCliente, items: allItems }) => {

            console.log('OC:', ocNum, 'Cliente:', nomeCliente, 'Itens:', allItems.length);

            // Aplicar filtro de Marfim (itens j√° v√™m sem Excluido)
            let itens = allItems;
            if (marfimFilter === 'cm') {
                itens = itens.filter(item => item.TAMANHO && item.TAMANHO.toUpperCase().includes('CM'));
            } else if (marfimFilter === 'mm') {
                itens = itens.filter(item => item.TAMANHO && item.TAMANHO.toUpperCase().includes('MM'));
            }

            console.log('Itens ap√≥s filtro Marfim:', itens.length);
            if (itens.length > 0) {
                console.log('üìã Primeiros 3 itens que ser√£o impressos:');
                itens.slice(0, 3).forEach((item, i) => {
                    console.log(`  Item ${i+1}:`, {
                        CARTELA: item.CARTELA,
                        'C√ìD. CLIENTE': item['C√ìD. CLIENTE'],
                        DESCRI√á√ÉO: item.DESCRI√á√ÉO?.substring(0, 30),
                        TAMANHO: item.TAMANHO,
                        'C√ìD. OS': item['C√ìD. OS'],
                        'PRAZO': item.PRAZO,
                        'DATA RECEB.': item['DATA RECEB.'],
                        'DT. ENTREGA': item['DT. ENTREGA']
                    });
                });
            }

            if (itens.length === 0) {
                console.log('OC', ocNum, 'n√£o tem itens ap√≥s filtro');
                return;
            }

            // Verificar avisos
            const temInativos = ocData.items.some(item => item.Status === 'Inativo');
            const temFaturados = ocData.items.some(item => item.Status === 'Faturado');

            let avisos = [];
            if (temFaturados) avisos.push('‚ö†Ô∏è Cont√©m itens Faturados');
            if (temInativos) avisos.push('‚ö†Ô∏è Cont√©m itens Inativos');

            html += `
                <div class="oc-section">
                    <div class="oc-header ${temFaturados ? 'faturado-pending' : ''}">
                        <div class="oc-title">OC: ${ocNum} - ${nomeCliente}</div>
                        ${avisos.length > 0 ? `<div class="oc-avisos">${avisos.join(' | ')}</div>` : ''}
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Cartela</th>
                                <th>C√≥d. Cliente</th>
                                <th>Descri√ß√£o</th>
                                <th>Tamanho</th>
                                <th>Qtd. Aberta</th>
                                <th>OS</th>
                                <th>Dt. Recebimento</th>
                                <th>Dt. Entrega</th>
                                <th>Prazo</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            itens.forEach((item, idx) => {
                const qtdAberta = item['QTD. ABERTA'] || 0;
                const dtRecebimento = formatarData(item['DATA RECEB.']);
                const dtEntrega = formatarData(item['DT. ENTREGA']);

                // MESMA L√ìGICA DOS CARDS - usar ?? (nullish coalescing)
                const prazo = item.PRAZO ?? 'N/A';
                const codOS = item['C√ìD. OS'] ?? 'N/A';

                // Log para debug apenas se N/A (dados realmente ausentes)
                if (prazo === 'N/A' || codOS === 'N/A') {
                    console.log(`‚ö†Ô∏è Item ${idx} da OC ${ocNum} - Dado ausente na planilha:`, {
                        CARTELA: item.CARTELA,
                        'PRAZO': item.PRAZO,
                        'C√ìD. OS': item['C√ìD. OS']
                    });
                }

                html += `
                    <tr>
                        <td>${item.CARTELA || ''}</td>
                        <td>${item['C√ìD. CLIENTE'] || ''}</td>
                        <td>${item.DESCRI√á√ÉO || ''}</td>
                        <td>${item.TAMANHO || ''}</td>
                        <td>${qtdAberta}</td>
                        <td>${codOS}</td>
                        <td>${dtRecebimento}</td>
                        <td>${dtEntrega}</td>
                        <td>${prazo}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
        });

        html += `
        </body>
        </html>
        `;

        printWindow.document.write(html);
        printWindow.document.close();

        // Aguardar carregamento e imprimir
        setTimeout(() => {
            printWindow.print();
        }, 250);

        // Fechar modal
        $relatorioModal.classList.add('hidden');
    }

    // ==== INICIALIZA√á√ÉO ====
    document.addEventListener('DOMContentLoaded', carregarListaOcs); 

  </script>
</body>
</html>
